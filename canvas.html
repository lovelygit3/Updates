<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hallows Eve Dashboard</title>

<style>
:root{--bg-img:url("https://picsum.photos/id/1011/1600/900");--bg-col:#000;--text:#fff;
      --accent:#7cffb2;--muted:rgba(255,255,255,.65);--r:12px;--w:150px;--h:225px;
      font-family:Inter,system-ui,sans-serif}
html,body{height:100%;margin:0;color:var(--text)}
body{background:var(--bg-col) var(--bg-img) center/cover no-repeat fixed;
     display:flex;flex-direction:column;overflow:hidden}
/*  ▾  condensed style blocks (unchanged from previous file)  ▾  */
#splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:1000}
#splash h1{font-size:3rem;margin:0;letter-spacing:.15rem}
.loader{width:240px;height:6px;background:#333;border-radius:3px;margin-top:24px;overflow:hidden}
.loader::before{content:"";display:block;width:40%;height:100%;background:var(--accent);animation:load 1.2s linear infinite}
@keyframes load{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
@keyframes splashOut{to{opacity:0;visibility:hidden}}
#app{flex:1;display:flex;flex-direction:column;opacity:0;animation:appIn .6s 1.4s forwards}
@keyframes appIn{to{opacity:1}}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 24px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px)}
#brand{margin:0;font-size:1.55rem;letter-spacing:.12rem}
.nav{display:flex;gap:10px}
.btn{background:transparent;border:2px solid var(--accent);color:var(--text);padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer}
.btn:hover{background:var(--accent);color:#000}
.page{display:none;flex:1;overflow:auto;padding:26px}
.page.active{display:block;animation:pgIn .4s}@keyframes pgIn{from{opacity:0;transform:translateY(24px)}to{opacity:1}}
#homePage{display:flex;flex-direction:column;align-items:center;text-align:center}
#homePage h2{font-size:2.4rem;margin:0 0 10px}
.upBox{background:rgba(255,255,255,.07);padding:22px 26px;border-radius:var(--r);max-width:540px}
.list{display:flex;flex-direction:column;gap:20px;max-width:1200px;margin:auto}
.card{display:flex;gap:16px;padding:14px;background:rgba(255,255,255,.07);border-radius:var(--r);align-items:center;box-shadow:0 6px 18px #000a}
.cover{width:var(--w);height:var(--h);border-radius:var(--r);overflow:hidden;cursor:pointer}
.cover img{width:100%;height:100%;object-fit:cover;transition:transform .35s}
.cover:hover img{transform:scale(1.07)}
.title{font-size:1.05rem;font-weight:700}.descr{font-size:.9rem;color:var(--muted)}
.launch{margin-left:auto;background:var(--accent);color:#000;border:none;border-radius:8px;padding:8px 16px;font-weight:600;cursor:pointer}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:900}
#playerBox{width:90%;height:85%;background:#000;border-radius:var(--r);overflow:hidden;position:relative;display:flex;flex-direction:column}
#player{flex:1;border:none;background:#000}
.ovBtns{position:fixed;top:18px;right:24px;display:flex;gap:10px;z-index:1001}
.ovBtn{background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:6px;padding:8px 12px;font-size:18px;cursor:pointer}
#settings{position:fixed;top:76px;right:24px;background:#111;padding:14px;border:1px solid #333;border-radius:var(--r);display:none;z-index:950;width:260px}
#settings label{font-size:.83rem;color:var(--muted)}
#settings input{width:100%;padding:6px;border-radius:5px;border:1px solid #444;background:#222;color:#ddd;margin-bottom:10px;font-size:.85rem}
#settings .btn{width:100%;padding:6px}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 6px 18px #000a;z-index:1100;display:flex;gap:10px;align-items:center;opacity:0;animation:toastIn .3s forwards}
@keyframes toastIn{to{opacity:1}}
.toast button{background:var(--accent);border:none;border-radius:6px;padding:4px 8px;font-weight:600;cursor:pointer;color:#000;font-size:.8rem}
</style>
</head>
<body>
<div id="buildTag" style="position:fixed;top:6px;left:6px;
            font:12px/14px monospace;background:#000a;padding:2px 6px;
            border-radius:4px;z-index:1200;color:#fff">
  build <span id="buildNo"></span>
</div>
<!-- splash -->
<div id="splash"><h1>HALLOWS EVE</h1><div class="loader"></div></div>

<!-- app -->
<div id="app">
  <header>
    <h1 id="brand">HALLOWS EVE</h1>
    <div class="nav">
      <button class="btn navBtn" data-page="home">Home</button>
      <button class="btn navBtn" data-page="movies">Movies</button>
      <button class="btn navBtn" data-page="games">Games</button>
      <button class="btn" id="gear">⚙️</button>
    </div>
  </header>

  <section id="home" class="page active">
    <div id="homePage">
      <h2>Welcome</h2>
      <div class="upBox"><p>Self-updating dashboard • FNF playable</p></div>
    </div>
  </section>

  <section id="movies" class="page"><div class="list" id="movieList"></div></section>
  <section id="games"  class="page"><div class="list" id="gameList"></div></section>
</div>

<!-- overlay -->
<div id="overlay">
  <div class="ovBtns"><button class="ovBtn" id="ovFull">⛶</button><button class="ovBtn" id="ovClose">✖</button></div>
  <div id="playerBox"><iframe id="player" allowfullscreen></iframe></div>
</div>

<!-- settings -->
<div id="settings">
  <label>Background image URL</label><input id="bgInput" type="text">
  <label>Text colour</label><input id="txtColor" type="color">
  <label>Accent / button colour</label><input id="accColor" type="color">
  <label><input type="checkbox" id="autoUpd"> Auto-update dashboard</label>
  <button class="btn" id="chkUpd">Check update now</button>
  <button class="btn" id="saveTheme">Save & apply</button>
</div>
<script>

/* ─────  CONSTANTS  ───── */
const BUILD       = '2025-11-2;          // bump here + in version.json for new release
const MAIN_FILE   = 'canvas.html';
const RAW_ROOT =    'https://cdn.jsdelivr.net/gh/lovelygit3/Updates';
const VERSION_URL = '${RAW_ROOT}@main/version.json';
document.getElementById('buildNo').textContent = BUILD;
console.log('[Dashboard] running build', BUILD);

/* ─────  HELPERS  ───── */
const q = s => document.querySelector(s);
const qa = s => [...document.querySelectorAll(s)];
function toast(msg, buttons = []) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  buttons.forEach(([txt, fn]) => {
    const b = document.createElement('button');
    b.textContent = txt;
    b.onclick = () => { fn(); t.remove(); };
    t.appendChild(b);
  });
  document.body.appendChild(t);
  if (!buttons.length) {
    setTimeout(() => t.style.opacity = '0', 4500);
    setTimeout(() => t.remove(), 5200);
  }
}

/* ─────  SPLASH  ───── */
setTimeout(() => q('#splash').style.animation = 'splashOut .6s forwards', 1300);
setTimeout(() => q('#splash').remove(), 1900);


/* ─────  THEME  ───── */
function applyTheme(o){ if(o.bg)document.documentElement.style.setProperty('--bg-img',`url(${o.bg})`);
  if(o.text)document.documentElement.style.setProperty('--text',o.text);
  if(o.acc) document.documentElement.style.setProperty('--accent',o.acc); }
const saved=JSON.parse(localStorage.getItem('hallowsTheme')||'{}');applyTheme(saved);
if(saved.bg)q('#bgInput').value=saved.bg;if(saved.text)q('#txtColor').value=saved.text;if(saved.acc)q('#accColor').value=saved.acc;
q('#gear').onclick=()=>q('#settings').style.display=q('#settings').style.display?'':'block';
q('#saveTheme').onclick=()=>{const o={bg:q('#bgInput').value.trim(),text:q('#txtColor').value,acc:q('#accColor').value};
  localStorage.setItem('hallowsTheme',JSON.stringify(o));applyTheme(o);q('#settings').style.display='none';};

/* ─────  AUTO-UPDATE PREF  ───── */
q('#autoUpd').checked=JSON.parse(localStorage.getItem('autoUpdDash')||'false');
q('#autoUpd').onchange=e=>localStorage.setItem('autoUpdDash',e.target.checked);

/* ─────  UPDATE CHECKER  ───── */
async function checkUpdate(manual = false) {
  try {
    const res = await fetch(VERSION_URL + '?t=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('http ' + res.status);
    const remoteBuild = String((await res.json()).build || '').trim();
    const localBuild  = String(BUILD).trim();

    if (remoteBuild !== localBuild) {

      /* avoid endless loop in one tab */
      const already = sessionStorage.getItem('triedBuild');

      const reload = () => {
        sessionStorage.setItem('triedBuild', remoteBuild);

        /* swap any "@…" to "@latest" and add cache-buster */
        const clean = location.href.split('#')[0].split('?')[0];
        const latest = clean.includes('@') ? clean.replace(/@[^/]+/, '@latest')
                                           : clean;
        location.href = latest + '?t=' + Date.now();
      };

      if (already !== remoteBuild) {
        if (q('#autoUpd').checked) {
          toast('Updating dashboard…');
          reload();
        } else {
          toast('New version available', [['Update now', reload],
                                          ['Dismiss', () => 0]]);
        }
      } else if (manual) {
        toast('Update failed – clear browser cache');
      }

    } else {
      sessionStorage.removeItem('triedBuild');
      if (manual) toast('No update – latest build');
    }
  } catch (err) {
    if (manual) toast('Update check failed');
    console.warn('update-check:', err.message);
  }
}
q('#chkUpd').onclick = () => checkUpdate(true);
checkUpdate();

q('#chkUpd').onclick = () => checkUpdate(true);  // manual button
checkUpdate();                                   // first run
/* manual button */
q('#chkUpd').onclick = () => checkUpdate(true);
/* automatic on start */
checkUpdate();
/* ─────  NAVIGATION  ───── */
qa('.navBtn').forEach(b=>b.onclick=()=>{qa('.page').forEach(p=>p.classList.remove('active'));q('#'+b.dataset.page).classList.add('active');});

/* movies */
const movies = [
  {
    title : 'Sample Movie',
    cover : 'https://picsum.photos/200/300?1',
    descr : 'YT demo',
    url   : 'https://www.youtube.com/embed/dQw4w9WgXcQ'
  },
  {
    title : 'Big Buck Bunny',
    cover : 'https://peach.blender.org/wp-content/uploads/bbb-splash.png',
    descr : 'Blender Open Movie',
    url   : 'https://www.youtube.com/embed/YE7VzlLtp-4'
  },
  {
    title : 'Sintel',
    cover : 'https://download.blender.org/durian/trailer/sintel_trailer-480p.png',
    descr : 'Another Blender short',
    url   : 'https://www.youtube.com/embed/eRsGyueVLvQ'
  }
];

/* games */
const games = [
  {
    title : 'Friday Night Funkin\'',
    cover : 'https://picsum.photos/200/300?3',
    descr : 'jsDelivr',
    url   : 'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/index.html'
  },
  {
    title : 'Jelly Mario',
    cover : 'https://upload.wikimedia.org/wikipedia/commons/7/7d/2048_logo.svg',
    descr : 'Classic puzzle',
    url   : 'https://gamesgo.net/game/friday-night-funkin-vs-qt-mod'
  },
  {
    title : 'Celeste Classic',
    cover : 'https://raw.githubusercontent.com/mmalet/celeste-classic/master/assets/cover.png',
    descr : 'Pico-8 version',
    url   : 'https://www.lexaloffle.com/bbs/?pid=2397#p'
  }
];
/* ─────  CARD BUILDER  ───── */
function card(o){const d=document.createElement('div');d.className='card';d.dataset.url=o.url;
  d.innerHTML=`<div class="cover"><img src="${o.cover}"></div>
               <div class="meta"><div class="title">${o.title}</div>
               <div class="descr">${o.descr}</div></div>
               <button class="launch">Launch</button>`;return d;}
function fill(sel,arr){const L=q(sel);L.innerHTML='';arr.forEach(o=>L.appendChild(card(o)));}
fill('#movieList',movies);fill('#gameList',games);

/* ─────  OVERLAY  ───── */
const ov=q('#overlay'),player=q('#player');
q('#ovClose').onclick=()=>{ov.style.display='none';player.src='about:blank';};
q('#ovFull').onclick=()=>player.requestFullscreen?.();

/* ─────  PAGE LOADER (FNF fix)  ───── */
function absolutise(html,base){
  const fix=(attr,q)=>html.replace(new RegExp(`${attr}=${q}\\/`,'g'),`${attr}=${q}${base}`);
  html=fix('src','"');html=fix('src','\'');html=fix('href','"');html=fix('href','\'');
  return html.replace(/(["'(])assets\//g,`$1${base}assets/`)
             .replace(/url\(\s*['"]?\/([^)'"]*)['"]?\s*\)/g,`url(${base}$1)`);
}
function interceptor(base){return `<script>(function(){const B='${base}'.replace(/\\\\/g,'\\\\\\\\');function p(u){return u&&u.startsWith('/')?B+u.slice(1):u}const O=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(m,u){arguments[1]=p(u);return O.apply(this,arguments);};const F=fetch;window.fetch=function(u,...r){return F(p(u),...r);};})();<\/script>`;}
async function loadPage(url){
  try{const txt=await(await fetch(url)).text();const base=url.slice(0,url.lastIndexOf('/')+1);
    player.removeAttribute('src');player.srcdoc=`<base href="${base}">`+interceptor(base)+absolutise(txt,base);}
  catch(e){console.error(e);player.removeAttribute('srcdoc');player.src=url;}
}

/* click delegation */
document.addEventListener('click',e=>{
  if(!(e.target.closest('.launch')||e.target.closest('.cover')))return;
  const url=e.target.closest('.card').dataset.url;if(!url)return;
  if(/\.(html?|php)$/i.test(url)) loadPage(url); else{player.removeAttribute('srcdoc');player.src=url;}
  ov.style.display='flex';
});
</script>
</body>
</html>
