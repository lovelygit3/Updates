<script>
(() => {               /*  ←--- added wrapper  */

/* ── CONSTANTS ── */
const BUILD = '2025-11-2-b';
const VERSION_URL   = 'https://cdn.jsdelivr.net/gh/lovelygit3/Updates@main/version.json';
const DASHBOARD_URL = 'https://cdn.jsdelivr.net/gh/lovelygit3/Updates@latest/canvas.html';
document.getElementById('buildNo').textContent = BUILD;

/* ── HELPERS ── */
const q  = s => document.querySelector(s);
const qa = s => [...document.querySelectorAll(s)];
function toast(msg, btns=[]){
  const t = Object.assign(document.createElement('div'),{className:'toast',textContent:msg});
  btns.forEach(([txt,fn])=>{
    const b=document.createElement('button');b.textContent=txt;
    b.onclick=()=>{fn();t.remove();};
    t.appendChild(b);
  });
  document.body.appendChild(t);
  if(!btns.length){setTimeout(()=>t.style.opacity=0,4000);setTimeout(()=>t.remove(),4700);}
}

/* ── SPLASH ── */
setTimeout(()=>q('#splash').style.animation='splashOut .6s forwards',1200);
setTimeout(()=>q('#splash').remove(),1800);

/* ── THEME / SETTINGS PANEL ── */
function applyTheme(o){
  if(o.bg)  document.documentElement.style.setProperty('--bg-img',`url(${o.bg})`);
  if(o.text)document.documentElement.style.setProperty('--text',o.text);
  if(o.acc) document.documentElement.style.setProperty('--accent',o.acc);
}
const savedTheme = JSON.parse(localStorage.getItem('hallowsTheme')||'{}');
applyTheme(savedTheme);
if(savedTheme.bg)   q('#bgInput').value=savedTheme.bg;
if(savedTheme.text) q('#txtColor').value=savedTheme.text;
if(savedTheme.acc)  q('#accColor').value=savedTheme.acc;

const settingsBox = q('#settings');
q('#gear').onclick = () => {
  settingsBox.style.display = settingsBox.style.display ? '' : 'block';
};
q('#saveTheme').onclick = () => {
  const o = { bg:q('#bgInput').value.trim(),
              text:q('#txtColor').value,
              acc:q('#accColor').value };
  localStorage.setItem('hallowsTheme',JSON.stringify(o));
  applyTheme(o);
  settingsBox.style.display='none';
};

/* store / load auto-update checkbox */
q('#autoUpd').checked  = JSON.parse(localStorage.getItem('autoUpdDash')||'false');
q('#autoUpd').onchange = e => localStorage.setItem('autoUpdDash',e.target.checked);

/* ── SELF-UPDATER ── */
async function fetchRemoteBuild(){
  try{const r = await fetch(VERSION_URL+'?t='+Date.now(),{cache:'no-store'});
      if(!r.ok) throw Error(r.status);
      return String((await r.json()).build||'').trim();
  }catch(e){console.warn('version fetch',e);return null;}
}
async function installLatest(){
  const r = await fetch(DASHBOARD_URL+'?t='+Date.now(),{cache:'no-store'});
  if(!r.ok) throw Error(r.status);
  document.open(); document.write(await r.text()); document.close();
}
async function updater(manual=false){
  if(!manual && !q('#autoUpd').checked) return;
  if(sessionStorage.getItem('justUpdated')===BUILD){
    sessionStorage.removeItem('justUpdated'); return;
  }
  const remote = await fetchRemoteBuild();
  if(remote && remote!==BUILD){
    sessionStorage.setItem('justUpdated',remote);
    toast('Updating dashboard…'); await installLatest();
  }else if(manual){ toast('You already have the latest build'); }
}
q('#chkUpd').onclick = ()=>updater(true);
updater();

/* ── NAVIGATION ── */
qa('.navBtn').forEach(b=>b.onclick=()=>{
  qa('.page').forEach(p=>p.classList.remove('active'));
  q('#'+b.dataset.page).classList.add('active');
});

/* MOVIES / GAMES DATA */
const movies=[
  {title:'Sample Movie',cover:'https://picsum.photos/200/300?1',descr:'YT demo',url:'https://www.youtube.com/embed/dQw4w9WgXcQ'},
  {title:'Big Buck Bunny',cover:'https://peach.blender.org/wp-content/uploads/bbb-splash.png',descr:'Blender Open Movie',url:'https://www.youtube.com/embed/YE7VzlLtp-4'},
  {title:'Sintel',cover:'https://download.blender.org/durian/trailer/sintel_trailer-480p.png',descr:'Another Blender short',url:'https://www.youtube.com/embed/eRsGyueVLvQ'}
];
const games=[
  {title:"Friday Night Funkin'",cover:'https://picsum.photos/200/300?3',descr:'jsDelivr',url:'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/index.html'},
  {title:'Jelly Mario',cover:'https://upload.wikimedia.org/wikipedia/commons/7/7d/2048_logo.svg',descr:'Classic puzzle',url:'https://gamesgo.net/game/friday-night-funkin-vs-qt-mod'},
  {title:'Celeste Classic',cover:'https://raw.githubusercontent.com/mmalet/celeste-classic/master/assets/cover.png',descr:'Pico-8',url:'https://www.lexaloffle.com/bbs/?pid=2397#p'}
];

/* ── CARD MAKER / LISTS ── */
function card(o){
  const d=document.createElement('div'); d.className='card'; d.dataset.url=o.url;
  d.innerHTML=`<div class="cover"><img src="${o.cover}"></div><div class="meta"><div class="title">${o.title}</div><div class="descr">${o.descr}</div></div><button class="launch">Launch</button>`;
  return d;
}
function fill(sel,arr){const box=q(sel); box.innerHTML=''; arr.forEach(o=>box.appendChild(card(o)));}
fill('#movieList',movies); fill('#gameList',games);

/* ── OVERLAY / ADVANCED PAGE-LOADER ── */
const ov=q('#overlay'), player=q('#player');
q('#ovClose').onclick = ()=>{ov.style.display='none';player.src='about:blank';};
q('#ovFull' ).onclick = ()=>player.requestFullscreen?.();

function absolutise(html,base){
  const fix=(attr,q)=>html.replace(new RegExp(`${attr}=${q}/`,'g'),`${attr}=${q}${base}`);
  html = fix('src','"'); html = fix('src','\''); html = fix('href','"'); html = fix('href','\'');
  return html.replace(/(["'(])assets\//g,`$1${base}assets/`)
             .replace(/url\(\s*['"]?\/([^)'"]*)['"]?\s*\)/g,`url(${base}$1)`);
}
function interceptor(base){
  return `<script>(function(){
    const ABS='${base}'.replace(/\\\\/g,'\\\\\\\\');
    const patch=u=>u&&u.startsWith('/')?ABS+u.slice(1):u;
    const O=XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open=function(m,u){arguments[1]=patch(u);return O.apply(this,arguments);};
    const F=fetch;window.fetch=function(u,...r){return F(patch(u),...r);};
  })();<\/script>`;
}
async function loadPage(url){
  try{
    const txt = await (await fetch(url)).text();
    const base = url.slice(0,url.lastIndexOf('/')+1);
    player.removeAttribute('src');
    player.srcdoc = `<base href="${base}">` + interceptor(base) + absolutise(txt,base);
  }catch(e){
    console.error(e); player.removeAttribute('srcdoc'); player.src=url;
  }
}
document.addEventListener('click',e=>{
  const trg = e.target.closest('.launch,.cover'); if(!trg) return;
  const url = trg.closest('.card').dataset.url;
  if(/\.(html?|php)$/i.test(url)) loadPage(url);
  else { player.removeAttribute('srcdoc'); player.src=url; }
  ov.style.display='flex';
});

})();  /* ←--- end wrapper */
</script>
