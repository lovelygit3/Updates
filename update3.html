<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="app-version" content="1.7.1">
<title>Media Hub</title>
<link id="dynamic-favicon" rel="icon" href="">
<style>
  :root {
    --rosewater: #F5E0DC;
    --flamingo: #F2CDCD;
    --pink: #F5C2E7;
    --mauve: #CBA6F7;
    --red: #F38BA8;
    --maroon: #EBA0AC;
    --peach: #FAB387;
    --yellow: #F9E2AF;
    --green: #A6E3A1;
    --teal: #94E2D5;
    --sky: #89DCEB;
    --sapphire: #74C7EC;
    --blue: #89B4FA;
    --lavender: #B4BEFE;
    --text: #CDD6F4;
    --subtext: #A6ADC8;
    --surface1: #45475A;
    --surface0: #313244;
    --base: #1E1E2E;
    --mantle: #181825;

    --bg-color: var(--base);
    --bg-image: none;
    --text-color: var(--text);
    --accent-color: var(--mauve);
    --button-color: var(--blue);
    --effect-color: rgba(203,166,247,0.3);
    --nav-bg: rgba(24,24,37,0.6);
    --nav-active: var(--accent-color);
    --card-bg: rgba(49,50,68,0.75);
    --shadow-color: rgba(0,0,0,0.35);

    /* New: Customizable font size and performance mode */
    --font-size-base: 16px;
    --performance-mode: 0; /* 1 = enabled, reduces effects */
    --viewer-width: 98vw;
    --viewer-height: 98vh;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    color: var(--text-color);
    background-color: var(--bg-color);
    background-image: var(--bg-image);
    background-size: cover;
    background-position: center;
    transition: background-color 300ms ease, color 300ms ease, background-image 300ms ease;
    font-size: var(--font-size-base);
  }
  body.no-scroll { overflow: hidden; }
  body.performance-mode {
    --shadow-color: transparent; /* Reduce shadows */
    transition: none; /* Disable transitions for perf */
  }

  /* Theme-specific classes for layout and button variations */
  body.theme-nordic-dark {
    --button-border-radius: 8px; /* Standard buttons */
    --layout-grid-gap: 16px; /* Standard spacing */
  }
  body.theme-sweet {
    --button-border-radius: 8px;
    --layout-grid-gap: 16px;
  }
  body.theme-chrome-os {
    --button-border-radius: 8px;
    --layout-grid-gap: 16px;
  }
  body.theme-dracula {
    --button-border-radius: 8px;
    --layout-grid-gap: 16px;
  }
  body.theme-halloween {
    --button-border-radius: 12px;
    --layout-grid-gap: 18px;
    /* Spooky effects */
    .card { border: 2px solid orange; }
    .btn { background: linear-gradient(135deg, orange, purple); color: black; }
    /* Subtle Halloween background pattern */
    body { background-image: linear-gradient(45deg, black 25%, transparent 25%), linear-gradient(-45deg, black 25%, transparent 25%), linear-gradient(45deg, transparent 75%, black 75%), linear-gradient(-45deg, transparent 75%, black 75%); background-size: 20px 20px; }
  }
  body.theme-christmas {
    --button-border-radius: 10px;
    --layout-grid-gap: 20px;
    /* Festive effects: Snow pattern, red/green borders */
    .card { border: 2px solid #228B22; } /* Green border */
    .btn { background: linear-gradient(135deg, #FF0000, #228B22); color: white; } /* Red to green gradient */
    /* Subtle snow background pattern */
    body { background-image: radial-gradient(white 15%, transparent 16%); background-size: 30px 30px; background-color: #101418; }
    .nav button { border: 1px solid #FF0000; } /* Red borders for nav */
    .home-hero { background: linear-gradient(135deg, #228B22, #FF0000); color: white; border: none; } /* Festive hero */
    .modal-inner { background: #101418; border: 2px solid #228B22; } /* Green bordered popups */
  }
  body.theme-mandela {
    --button-border-radius: 4px;
    --layout-grid-gap: 12px;
    /* 90's black and white creepy theme */
    filter: grayscale(100%) contrast(1.2); /* Black and white filter */
    font-family: 'Courier New', monospace; /* Old-school font */
    /* Creepy effects: Slight glitch animation */
    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(2px, -2px); }
      60% { transform: translate(-2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    body { animation: glitch 2s infinite; background-color: #000; color: #FFF; }
    .card, .btn, .modal-inner { border: 1px solid #FFF; background: #333; color: #FFF; }
    .nav button { background: #000; color: #FFF; border: 1px solid #FFF; }
    .nav button:hover { background: #FFF; color: #000; }
  }

  .grid { gap: var(--layout-grid-gap, 16px); }
  .btn { border-radius: var(--button-border-radius, 8px); }

  .topbar {
    position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px); background: var(--nav-bg);
    display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; border-bottom: 1px solid var(--surface1);
  }

  .user-id { display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
  .avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-color), var(--button-color)); box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; }
  .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .username { font-weight: 600; letter-spacing: 0.2px; }
  .profile-dropdown { position: absolute; top: 48px; left: 0; width: 320px; background: var(--card-bg); border: 1px solid var(--surface1); border-radius: 10px; box-shadow: 0 12px 30px var(--shadow-color); padding: 12px; display: none; }
  .profile-dropdown label { font-size: 12px; color: var(--subtext); }
  .profile-dropdown input, .profile-dropdown textarea { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); color: var(--text-color); outline: none; margin-top: 4px; margin-bottom: 8px; }
  .profile-actions { display: flex; gap: 8px; }

  .btn { padding: 8px 12px; border: none; cursor: pointer; font-weight: 600; transition: transform 120ms ease, box-shadow 120ms ease, background-color 200ms ease, color 200ms ease; animation: btn-pulse 1.5s infinite alternate; }
  @keyframes btn-pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
  .btn-primary { background: var(--button-color); color: #0b0b12; box-shadow: 0 6px 18px color-mix(in oklab, var(--button-color) 60%, black 40%); }
  .btn-primary:hover { transform: translateY(-1px); }
  .btn-secondary { background: transparent; border: 1px solid var(--surface1); color: var(--text-color); }
  .btn-delete { background: var(--red); color: white; }

  .nav { display: flex; gap: 8px; }
  .nav button { background: transparent; border: 1px solid var(--surface1); color: var(--text-color); padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: background-color 200ms ease, color 200ms ease, border-color 200ms ease, transform 120ms ease; }
  .nav button:hover { background: rgba(203,166,247,0.12); transform: translateY(-1px); }
  .nav button.active { background: var(--nav-active); color: #0a0a10; border-color: transparent; box-shadow: 0 8px 20px color-mix(in oklab, var(--nav-active) 60%, black 40%); }

  main { padding: 20px; max-width: 1200px; margin: 0 auto; } /* Removed bottom margin since player bar is gone */
  section.page { display: none; opacity: 0; transition: opacity 300ms ease-in-out; }
  section.page.active { display: block; opacity: 1; animation: fade-in 0.5s ease; }
  @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
  .card { background: var(--card-bg); border: 1px solid var(--surface1); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 20px var(--shadow-color); transition: transform 150ms ease, box-shadow 150ms ease, border-color 200ms ease; position: relative; animation: card-slide 0.3s ease; }
  @keyframes card-slide { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  .card:hover { transform: translateY(-2px); box-shadow: 0 14px 28px var(--shadow-color); border-color: var(--accent-color); }
  .card .thumb { width: 100%; height: 240px; background: linear-gradient(135deg, color-mix(in oklab, var(--accent-color) 28%, transparent), color-mix(in oklab, var(--button-color) 28%, transparent)); display: grid; place-items: center; color: var(--text-color); position: relative; }
  .card .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .thumb .edit-mask { position: absolute; inset: 0; display: grid; place-items: center; background: linear-gradient(180deg, rgba(0,0,0,0) 50%, rgba(0,0,0,0.35)); opacity: 0; transition: opacity 200ms ease; pointer-events: none; }
  .card .thumb:hover .edit-mask { opacity: 1; }
  .edit-mask .mask-btn { background: var(--accent-color); color: #0b0b12; border: none; border-radius: 999px; padding: 6px 12px; font-weight: 700; box-shadow: 0 8px 20px color-mix(in oklab, var(--accent-color) 60%, black 40%); pointer-events: all; cursor: pointer; }

  .card .info { padding: 10px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .small { font-size: 12px; color: var(--subtext); }
  .icon-btn { background: rgba(0,0,0,0.12); border: 1px solid var(--surface1); color: var(--text-color); padding: 6px 8px; border-radius: 8px; cursor: pointer; transition: background-color 200ms ease, border-color 200ms ease, transform 120ms ease; }
  .icon-btn:hover { background: rgba(203,166,247,0.18); transform: translateY(-1px); }

  .overlay { position: fixed; inset: 0; background: color-mix(in oklab, var(--mantle) 75%, black 25%); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 60; transition: opacity 300ms ease; }
  .overlay.open { display: flex; opacity: 1; animation: overlay-fade 0.3s ease; }
  @keyframes overlay-fade { from { opacity: 0; } to { opacity: 1; } }
  .viewer { position: relative; width: var(--viewer-width); height: var(--viewer-height); max-width: none; border-radius: 12px; overflow: hidden; background: var(--card-bg); border: 1px solid var(--surface1); box-shadow: 0 20px 40px var(--shadow-color); display: grid; grid-template-rows: auto 1fr; }
  .viewer-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(49,50,68,0.5); border-bottom: 1px solid var(--surface1); }
  .viewer-iframe { width: 100%; height: 100%; background: #0a0a0f; border: none; display: block; }

  .viewer.fs,
  .viewer:fullscreen {
    position: fixed !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    max-height: none !important;
    border-radius: 0 !important;
    grid-template-rows: 1fr !important;
    background: #000 !important;
  }
  .viewer.fs .viewer-header,
  .viewer:fullscreen .viewer-header { display: none !important; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-col { display: flex; flex-direction: column; gap: 6px; }
  input[type="color"], input[type="text"], input[type="url"], select { padding: 8px; border-radius: 8px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); color: var(--text-color); outline: none; }
  textarea { padding: 8px; border-radius: 8px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); color: var(--text-color); outline: none; min-height: 80px; }
  hr { border: none; border-top: 1px solid var(--surface1); margin: 16px 0; }

  .update-log { position: fixed; inset: 0; z-index: 80; display: none; align-items: center; justify-content: center; background: color-mix(in oklab, var(--mantle) 75%, black 25%); backdrop-filter: blur(10px); animation: log-fade 0.5s ease; }
  @keyframes log-fade { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  .update-box { width: 520px; max-width: 90%; background: var(--card-bg); border: 1px solid var(--surface1); border-radius: 12px; box-shadow: 0 18px 38px var(--shadow-color); padding: 16px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); font-size: 12px; color: var(--subtext); }

  .home-hero { padding: 20px; border: 1px solid var(--surface1); background: linear-gradient(145deg, rgba(49,50,68,0.5), rgba(49,50,68,0.3)); border-radius: 16px; box-shadow: 0 16px 36px var(--shadow-color); display: grid; grid-template-columns: 80px 1fr; gap: 24px; align-items: center; }
  .home-hero .avatar { width: 80px; height: 80px; } /* Bigger avatar */
  .chip { display: inline-block; margin-right: 6px; margin-top: 6px; padding: 4px 8px; border-radius: 999px; background: rgba(203,166,247,0.18); border: 1px solid var(--surface1); font-size: 12px; color: var(--text-color); }

  .list { display: grid; gap: 8px; }
  .list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 10px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); animation: list-item-slide 0.3s ease; }
  @keyframes list-item-slide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .searchbar { display: flex; gap: 8px; align-items: center; margin: 8px 0 16px 0; }
  .searchbar input { flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--surface1); background: rgba(49,50,68,0.5); color: var(--text-color); outline: none; }
  .searchbar .btn { white-space: nowrap; }

  .modal { position: fixed; inset: 0; z-index: 75; display: none; align-items: center; justify-content: center; background: color-mix(in oklab, var(--mantle) 70%, black 30%); backdrop-filter: blur(10px); }
  .modal-inner { width: 720px; max-width: 92%; background: var(--card-bg); border: 1px solid var(--surface1); border-radius: 14px; box-shadow: 0 20px 44px var(--shadow-color); padding: 16px; display: grid; grid-template-columns: 240px 1fr; gap: 16px; }
  .modal-preview { border: 1px solid var(--surface1); border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, color-mix(in oklab, var(--accent-color) 28%, transparent), color-mix(in oklab, var(--button-color) 28%, transparent)); height: 340px; display: grid; place-items: center; }
  .modal-preview img { width: 100%; height: 100%; object-fit: cover; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 8px; }

  /* Styles for Shows page */
  #shows .show-card { cursor: pointer; }

  /* Styles for Shows Modal - Movies page style */
  #showsModal .modal-inner { grid-template-columns: 1fr; gap: 0; }
  #showsModal .season-select { margin-bottom: 16px; }
  #showsModal .season-select select { width: 100%; }
  #showsModal .episodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto; }

  /* Added for scrolling only in games/movies boxes */
  #moviesGrid, #gamesList, #showsGrid {
    max-height: 60vh; /* Limit height to 60% of viewport height for scrolling */
    overflow-y: auto; /* Enable vertical scrolling */
    overflow-x: hidden; /* Prevent horizontal scrolling */
    padding-right: 8px; /* Optional: space for scrollbar */
  }

  /* Stylish recent cards */
  #recentGrid .card { border-radius: 16px; overflow: hidden; position: relative; transition: all 0.3s ease; }
  #recentGrid .card:hover { box-shadow: 0 12px 24px var(--shadow-color); }
  #recentGrid .thumb { background: linear-gradient(135deg, var(--accent-color), var(--button-color)); color: white; font-weight: bold; }
  #recentGrid .info { background: rgba(0,0,0,0.2); }

  /* Optimization for Chromebook: Bigger, more fashionable UI with larger elements, fonts, and padding */
  @media screen and (max-width: 1366px) and (max-height: 768px) {
    body {
      --font-size-base: 18px; /* Larger base font for better readability */
    }
    .grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* Larger cards for fashionable look */
      gap: 24px; /* More spacing */
    }
    main {
      max-width: 100%; /* Full width on smaller screens */
      padding: 24px; /* Increased padding for airier feel */
    }
    .topbar {
      padding: 12px 20px; /* Larger topbar */
    }
    .card .thumb {
      height: 280px; /* Larger thumbnails */
      border-radius: 16px; /* Softer corners for fashion */
    }
    .btn {
      padding: 12px 16px; /* Bigger buttons */
      font-size: 1.1em;
    }
    #moviesGrid, #gamesList, #showsGrid { max-height: 70vh; } /* More scrolling space since no player bar */
    .home-hero {
      padding: 24px; /* Larger hero section */
      grid-template-columns: 120px 1fr; /* Bigger avatar area */
      gap: 24px;
    }
    .avatar { width: 48px; height: 48px; } /* Larger avatars */
  }

  /* Enhanced Chromebook optimizations for other common res */
  @media screen and (max-width: 1366px) and (max-height: 768px),
         screen and (max-width: 1280px) and (max-height: 800px) { /* Common Chromebook res */
    body {
      --font-size-base: 18px; /* Larger fonts */
    }
    .grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Adjusted for balance */
      gap: 20px;
    }
    main { padding: 20px; }
    .card .thumb { height: 260px; }
    .topbar { padding: 10px 16px; }
    #moviesGrid, #gamesList, #showsGrid { max-height: 65vh; }
    #settings .form-row {
      grid-template-columns: 1fr 1fr; /* Keep two columns if possible */
      gap: 16px; /* Larger gaps */
    }
    #settings input, #settings select { padding: 10px; font-size: 16px; } /* Bigger inputs */
  }

  /* Styles for Walkthrough Modal - Fancy Windows Login Style */
  .walkthrough-modal { position: fixed; inset: 0; z-index: 70; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5) url('') no-repeat center/cover; backdrop-filter: blur(20px); }
  .walkthrough-inner { width: 680px; max-width: 90%; background: rgba(255,255,255,0.1); border: none; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); padding: 48px; position: relative; text-align: center; backdrop-filter: blur(10px); }
  .walkthrough-inner::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1), transparent); border-radius: 20px; }
  .walkthrough-step { display: none; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease; }
  .walkthrough-step.active { display: block; opacity: 1; transform: translateY(0); animation: fade-slide 0.5s ease; }
  @keyframes fade-slide { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
  .walkthrough-actions { display: flex; justify-content: space-between; margin-top: 20px; }
  .splash { animation: splash-effect 1s ease-in-out; }
  @keyframes splash-effect { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
  .animated-text { animation: text-glow 2s infinite alternate; display: inline-block; }
  @keyframes text-glow { 0% { text-shadow: 0 0 10px var(--accent-color); } 100% { text-shadow: 0 0 20px var(--accent-color); } }
  .preview-box { margin-top: 10px; padding: 10px; border: 1px solid var(--surface1); border-radius: 8px; background: var(--card-bg); }
  .preview-text { color: var(--text-color); background: var(--bg-color); padding: 5px; }
  .preview-btn { background: var(--button-color); color: #0b0b12; padding: 5px 10px; border-radius: 4px; }
  .walkthrough-inner label { display: block; margin-bottom: 16px; }
  .walkthrough-inner input, .walkthrough-inner textarea { width: 80%; margin: 0 auto; padding: 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 16px; text-align: center; }
  .walkthrough-inner input::placeholder, .walkthrough-inner textarea::placeholder { color: rgba(255,255,255,0.7); }
  .walkthrough-inner h2, .walkthrough-inner h3 { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

  /* Styles for recent dropdown */
  .recent-menu-btn { background: transparent; border: none; font-size: 20px; cursor: pointer; color: var(--text-color); }
  .recent-dropdown { position: absolute; background: var(--card-bg); border: 1px solid var(--surface1); border-radius: 8px; box-shadow: 0 8px 20px var(--shadow-color); padding: 8px; display: none; opacity: 0; transform: scale(0.9); transition: opacity 200ms ease, transform 200ms ease; z-index: 10; }
  .recent-dropdown.open { display: block; opacity: 1; transform: scale(1); animation: dropdown-open 0.2s ease; }
  @keyframes dropdown-open { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  .recent-dropdown button { display: block; width: 100%; text-align: left; padding: 8px; border: none; background: transparent; color: var(--text-color); cursor: pointer; }
  .recent-dropdown button:hover { background: var(--surface1); }
  .remove-btn { position: absolute; top: 4px; right: 4px; background: transparent; border: none; color: var(--subtext); cursor: pointer; font-size: 16px; }
  .remove-btn:hover { color: var(--red); }
</style>
</head>
<body>

<div class="topbar">
  <div class="user-id" id="userIdBtn">
    <div class="avatar"><img id="avatarImg" alt="avatar"></div>
    <div class="username" id="usernameText">User</div>
    <div class="profile-dropdown" id="profileDropdown">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <div class="avatar" style="width:48px; height:48px;"><img id="avatarPreview" alt="avatar preview"></div>
        <span class="badge">Profile</span>
      </div>
      <label>Username
        <input type="text" id="profileUsername" placeholder="Enter your username">
      </label>
      <label>Profile Picture URL
        <input type="url" id="profileAvatarUrl" placeholder="https://example.com/me.png">
      </label>
      <label>Description
        <textarea id="profileDescription" placeholder="Tell us about yourself"></textarea>
      </label>
      <label>Favorite Genres (comma-separated)
        <input type="text" id="profileGenres" placeholder="Action, RPG, Synthwave">
      </label>
      <div class="profile-actions">
        <button class="btn btn-secondary" id="profileCancel">Cancel</button>
        <button class="btn btn-primary" id="profileSave">Save</button>
      </div>
    </div>
  </div>

  <div class="nav">
    <button data-target="home" class="active">Home</button>
    <button data-target="movies">Movies</button>
    <button data-target="games">Games</button>
    <button data-target="shows">Shows</button>
    <button data-target="proxies">Proxies</button>
    <button data-target="settings">Settings</button>
  </div>
</div>

<main>
  <section id="home" class="page active">
    <div class="home-hero">
      <div class="avatar"><img id="homeAvatar" alt="avatar"></div>
      <div>
        <div style="display:flex; align-items:center; gap:8px;">
          <h2 id="homeUsername" style="margin:0;">Welcome, User</h2>
          <span class="badge">Catppuccin</span>
        </div>
        <p id="homeDescription" class="small" style="margin:6px 0 4px 0;">Customize your space with themes, movies, games, music, and more.</p>
        <div id="homeGenres"></div>
      </div>
    </div>
    <hr>
    <div style="display:flex; align-items:center; justify-content:space-between; position: relative;">
      <h3>Last Left Off</h3>
      <button class="recent-menu-btn" id="recentMenuBtn">â‹®</button>
      <div class="recent-dropdown" id="recentDropdown">
        <button onclick="toggleRecent(true)">Hide</button>
        <button onclick="toggleRecent(false)">Unhide</button>
        <button onclick="clearAllRecent()">Clear All</button>
      </div>
    </div>
    <div class="grid" id="recentGrid" style="grid-template-columns: repeat(auto-fit, minmax(240px,1fr));"></div>
  </section>

  <section id="movies" class="page">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h2>Movies</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-secondary" onclick="openMovieEditor(null)">Add Movie</button>
        <button class="btn btn-secondary" onclick="refreshMovies()">Refresh Grid</button>
      </div>
    </div>
    <div class="searchbar">
      <input type="text" id="movieSearch" placeholder="Search movies by title...">
      <button class="btn btn-secondary" onclick="clearMovieSearch()">Clear</button>
    </div>
    <p class="small muted">Click a cover to preview from Google Drive. Hover a cover to Edit image and link.</p>
    <div class="grid" id="moviesGrid"></div>
  </section>

  <section id="games" class="page">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h2>Games</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-secondary" onclick="addGamePrompt()">Add Game</button>
        <button class="btn btn-secondary" onclick="resetGames()">Reset List</button>
      </div>
    </div>
    <div class="searchbar">
      <input type="text" id="gameSearch" placeholder="Search games by title...">
      <button class="btn btn-secondary" onclick="clearGameSearch()">Clear</button>
    </div>
    <p class="small muted">enjoy</p>
    <div class="list" id="gamesList"></div>
  </section>

  <section id="shows" class="page">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h2>Shows (Experimental)</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-secondary" onclick="resetShows()">Reset</button>
      </div>
    </div>
    <p class="small muted">Click a show to view episodes in a modal. This is experimental.</p>
    <div class="grid" id="showsGrid"></div>
  </section>

  <section id="proxies" class="page">
    <h2>Proxies</h2>
    <p class="small muted">Simple list of proxies.</p>
    <div class="list" id="proxiesList"></div> <!-- Made dynamic for merging -->
  </section>

  <section id="settings" class="page">
    <h2>Settings</h2>
    <p class="small muted">Customize background, colors, theme, tab cloaker, and auto-update. Settings persist in localStorage.</p>
    <div class="form-row">
      <div class="form-col">
        <label>Background Color
          <input type="color" id="bgColorPicker">
        </label>
      </div>
      <div class="form-col">
        <label>Background Image URL
          <input type="url" id="bgImageUrl" placeholder="https://example.com/background.jpg">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Overall Theme Color
          <input type="color" id="overallThemeColor">
        </label>
      </div>
      <div class="form-col">
        <label>Accent Color
          <input type="color" id="accentColorPicker">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Button Color
          <input type="color" id="buttonColorPicker">
        </label>
      </div>
      <div class="form-col">
        <label>Text Color
          <input type="color" id="textColorPicker">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Effect Color
          <input type="color" id="effectColorPicker">
        </label>
      </div>
      <div class="form-col">
        <label>Preset Theme
          <select id="presetThemeSelect">
            <option value="">Select preset...</option>
            <option value="dark">Dark</option>
            <option value="halloween">Halloween</option>
            <option value="christmas">Christmas</option>
            <option value="nordic-dark">Nordic Dark</option>
            <option value="sweet">Sweet</option>
            <option value="chrome-os">Chrome OS</option>
            <option value="dracula">Dracula</option>
            <option value="mandela">Mandela</option>
          </select>
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Viewer Width (%)
          <input type="number" id="viewerWidthInput" min="50" max="100" value="98">
        </label>
      </div>
      <div class="form-col">
        <label>Viewer Height (%)
          <input type="number" id="viewerHeightInput" min="50" max="100" value="98">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Panic Key (e.g., Escape)
          <input type="text" id="panicKeyInput" placeholder="Escape">
        </label>
      </div>
      <div class="form-col">
        <label>Panic Redirect URL
          <input type="url" id="panicUrlInput" placeholder="https://www.google.com">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-col">
        <label>Font Size (px)
          <input type="number" id="fontSizeInput" min="12" max="20" value="16">
        </label>
      </div>
      <div class="form-col">
        <label>Performance Mode (for Chromebooks)
          <select id="performanceModeSelect">
            <option value="0">Off</option>
            <option value="1">On</option>
          </select>
        </label>
      </div>
    </div>
    <hr>
    <h3>Tab Cloaker</h3>
    <div class="form-row">
      <div class="form-col">
        <label>Tab Title
          <input type="text" id="tabTitleInput" placeholder="e.g., Google">
        </label>
      </div>
      <div class="form-col">
        <label>Favicon Image URL
          <input type="url" id="tabIconInput" placeholder="https://www.google.com/favicon.ico">
        </label>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <button class="btn btn-primary" id="applyTabCloakBtn">Apply Cloak</button>
      <button class="btn btn-secondary" id="cloakGoogleBtn">Cloak as Google</button>
      <button class="btn btn-secondary" id="cloakCanvasBtn">Cloak as Canvas</button>
      <button class="btn btn-secondary" id="resetCloakBtn">Reset Cloak</button>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      <button class="btn btn-secondary" onclick="resetSettings()">Reset to Default</button>
    </div>
  </section>
</main>

<div class="overlay" id="overlay">
  <div class="viewer" id="viewer">
    <div class="viewer-header" id="viewerHeader">
      <div class="viewer-title" id="viewerTitle">Viewer</div>
      <div style="display:flex; gap:8px;" id="viewerHeaderBtns">
        <button class="icon-btn" id="fullscreenBtn">Fullscreen</button>
        <button class="icon-btn" id="closeOverlayBtn">Close</button>
      </div>
    </div>
    <iframe class="viewer-iframe" id="viewerIframe" allowfullscreen></iframe>
  </div>
</div>

<!-- New Walkthrough Modal -->
<div class="walkthrough-modal" id="walkthrough">
  <div class="walkthrough-inner">
    <div class="walkthrough-step" id="step-welcome">
      <h2 class="splash">Welcome to Media Hub!</h2>
      <p class="small muted">Get ready to customize your experience. Let's set things up!</p>
    </div>
    <div class="walkthrough-step" id="step-user">
      <h3>User Customization</h3>
      <label>Username
        <input type="text" id="walkUsername" placeholder="Enter your username">
      </label>
      <label>Profile Picture URL
        <input type="url" id="walkAvatarUrl" placeholder="https://example.com/me.png">
      </label>
      <label>Description
        <textarea id="walkDescription" placeholder="Tell us about yourself"></textarea>
      </label>
      <label>Favorite Genres (comma-separated)
        <input type="text" id="walkGenres" placeholder="Action, RPG, Synthwave">
      </label>
      <p class="small muted">These will appear on your home screen before movies and games.</p>
    </div>
    <div class="walkthrough-step" id="step-ui">
      <h3>UI Customization</h3>
      <div class="form-row">
        <div class="form-col">
          <label>Background Color <span class="small muted">(Sets the main background)</span>
            <input type="color" id="walkBg">
          </label>
        </div>
        <div class="form-col">
          <label>Wallpaper URL <span class="small muted">(Background image)</span>
            <input type="url" id="walkWallpaper" placeholder="https://example.com/wallpaper.jpg">
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label>Overall Theme Color <span class="small muted">(Affects navigation and accents)</span>
            <input type="color" id="walkOverall">
          </label>
        </div>
        <div class="form-col">
          <label>Accent Color <span class="small muted">(Highlights and borders)</span>
            <input type="color" id="walkAccent">
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label>Button Color <span class="small muted">(Buttons and interactive elements)</span>
            <input type="color" id="walkButton">
          </label>
        </div>
        <div class="form-col">
          <label>Text Color <span class="small muted">(All text elements)</span>
            <input type="color" id="walkText">
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label>Effect Color <span class="small muted">(Subtle effects and overlays)</span>
            <input type="color" id="walkEffect">
          </label>
        </div>
      </div>
      <div class="preview-box">
        <p class="preview-text">Preview Text</p>
        <button class="preview-btn">Preview Button</button>
      </div>
    </div>
    <div class="walkthrough-step" id="step-congrats">
      <h2 class="animated-text">Enjoy Hallows Eve!</h2>
      <p class="small muted">Your setup is complete. Dive into Media Hub!</p>
    </div>
    <div class="walkthrough-actions">
      <button class="btn btn-secondary" id="walkBack">Back</button>
      <button class="btn btn-primary" id="walkNext">Next</button>
    </div>
  </div>
</div>

<div class="update-log" id="updateLog">
  <div class="update-box">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0;">Update Log</h3>
      <span class="badge" id="versionLabel">v1.7.1</span>
    </div>
    <p class="small">What's new:</p>
    <ul style="list-style: disc; padding-left: 20px;">
      <li>Removed auto-update function</li>
      <li>Fixed Google Drive movie embedding</li>
      <li>Improved music playback with CORS handling</li>
      <li>Enhanced Chromebook UI scaling</li>
      <li>Smaller settings menu for Chromebooks</li>
      <li>Added smooth animations</li>
      <li>Animated update log on startup</li>
    </ul>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn btn-primary" id="closeLogBtn">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="movieEditorModal">
  <div class="modal-inner">
    <div>
      <div class="modal-preview" id="moviePreviewBox">
        <img id="moviePreviewImg" alt="Cover preview">
      </div>
    </div>
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">Edit Movie</h3>
        <span class="badge">Cover & Link</span>
      </div>
      <div class="form-col" style="margin-top:8px;">
        <label>Title
          <input type="text" id="editMovieTitle" placeholder="Movie title">
        </label>
        <label>Cover Image URL
          <input type="url" id="editMovieCover" placeholder="https://example.com/cover.jpg">
        </label>
        <label>Google Drive Preview Link
          <input type="url" id="editMovieLink" placeholder="https://drive.google.com/file/.../preview">
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn btn-delete" id="movieEditDelete">Delete</button>
        <button class="btn btn-secondary" id="movieEditCancel">Cancel</button>
        <button class="btn btn-primary" id="movieEditSave">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- New Shows Modal -->
<div class="modal" id="showsModal">
  <div class="modal-inner">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <h3 id="showsModalTitle" style="margin:0;">Show Episodes</h3>
      <button class="icon-btn" id="showsModalClose">Close</button>
    </div>
    <div class="form-col season-select">
      <label>Season
        <select id="seasonDropdown">
          <!-- Options added dynamically -->
        </select>
      </label>
    </div>
    <div class="searchbar">
      <input type="text" id="episodeSearch" placeholder="Search episodes by title...">
      <button class="btn btn-secondary" onclick="clearEpisodeSearch()">Clear</button>
    </div>
    <div class="episodes-grid" id="episodesGrid"></div>
  </div>
</div>

<script>
  const LS_KEYS = {
    setupDone: 'setupDone',
    theme: 'themeSettings',
    currentTheme: 'currentThemeName',
    profile: 'userProfile',
    movies: 'moviesList',
    games: 'gamesList',
    shows: 'showsList', // New for shows
    recentViews: 'recentViews', // New for recent views
    recentHidden: 'recentHidden', // New for persistent hide
    tabCloak: 'tabCloakSettings',
    viewerWidth: 'viewerWidth',
    viewerHeight: 'viewerHeight',
    panicKey: 'panicKey',
    panicUrl: 'panicUrl',
    fontSize: 'fontSize',
    performanceMode: 'performanceMode',
    proxies: 'proxiesList' // New for dynamic proxies
  };

  const defaultTheme = {
    bgColor: getComputedStyle(document.documentElement).getPropertyValue('--base').trim() || '#1E1E2E',
    bgImage: '',
    overallThemeColor: getComputedStyle(document.documentElement).getPropertyValue('--mauve').trim() || '#CBA6F7',
    accentColor: getComputedStyle(document.documentElement).getPropertyValue('--mauve').trim() || '#CBA6F7',
    buttonColor: getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#89B4FA',
    textColor: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#CDD6F4',
    effectColor: 'rgba(203,166,247,0.3)'
  };
  const defaultProfile = { username: 'User', description: 'Customize your space with themes, movies, games, music, and more.', genres: ['Action','Adventure','Synthwave'], avatarUrl: '' };
  const defaultMovies = [
    { title: 'Insidious', coverUrl: '' },
    { title: ' A Nightmare On Elm Street', coverUrl: '' },
    { title: 'A Nightmare On Elm Street 3', coverUrl: '', driveLink: '' },
    { title: 'New Movie Example', coverUrl: '', driveLink: '' } // New for merging
  ];
  const defaultGames = [
    { title: 'Friday Night Funkin', src: './games/Fnf.html', runtime: 'classic' },
    { title: 'New Game Example', src: './games/new-game.html', runtime: 'classic' } // New for merging
  ];
  const defaultShows = [
    { title: 'Example Show', seasons: [
      { season: 1, episodes: [
        { number: 1, title: 'Pilot', url: 'https://drive.google.com/file/d/example1/preview', coverUrl: '' },
        { number: 2, title: 'The Adventure Begins', url: 'https://drive.google.com/file/d/example2/preview', coverUrl: '' }
      ] },
      { season: 2, episodes: [
        { number: 1, title: 'Return', url: 'https://drive.google.com/file/d/example3/preview', coverUrl: '' }
      ] }
    ] }
  ];
  const defaultProxies = [
    { title: 'Sakura', url: 'https://144-202-49-64.plesk.page/', description: 'Fast, simple HTTP proxy' },
    { title: 'Petezah', url: 'https://bav1.wadmc.site.cdn.cloudflare.net', description: '' },
    { title: 'Astroid', url: 'https://bav1.wadmc.site.cdn.cloudflare.net', description: '' },
    { title: 'New Proxy Example', url: 'https://new-proxy.example.com', description: 'New for updates' } // New for merging
  ];
  const defaultUpdateUrl = 'https://cdn.jsdelivr.net/gh/lovelygit3/Updates@main/update3.html';

  function saveJson(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){} }
  function loadJson(key, fallback){ try{ const raw=localStorage.getItem(key); if(raw==null) return fallback; return JSON.parse(raw); }catch(e){ return fallback; } }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function rgbToHex(rgb){ if(!rgb) return '#000000'; rgb=rgb.trim(); if(rgb.startsWith('#')) return rgb; const m=rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if(!m) return '#000000'; return '#' + [m[1],m[2],m[3]].map(x=>parseInt(x,10).toString(16).padStart(2,'0')).join(''); }
  function hexToRgba(hex,a=1){ hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r}, ${g}, ${b}, ${a})`; }
  function extractRGB(str){ const m=String(str||'').match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if(!m) return null; return `rgb(${m[1]}, ${m[2]}, ${m[3]})`; }
  function semverCompare(a,b){ const pa=a.split('.').map(n=>parseInt(n,10)||0), pb=b.split('.').map(n=>parseInt(n,10)||0); for(let i=0;i<Math.max(pa.length,pb.length);i++){const ai=pa[i]||0,bi=pb[i]||0; if(ai>bi) return 1; if(ai<bi) return -1;} return 0; }

  let theme = loadJson(LS_KEYS.theme, defaultTheme);
  let currentThemeName = localStorage.getItem(LS_KEYS.currentTheme) || '';
  let profile = loadJson(LS_KEYS.profile, defaultProfile);
  let movies = loadJson(LS_KEYS.movies, defaultMovies);
  let games = loadJson(LS_KEYS.games, defaultGames);
  let shows = loadJson(LS_KEYS.shows, defaultShows); // New: Load shows
  let proxies = loadJson(LS_KEYS.proxies, defaultProxies); // New: Load/merge proxies
  let recentViews = loadJson(LS_KEYS.recentViews, []); // New: Load recent views
  let recentHidden = localStorage.getItem(LS_KEYS.recentHidden) === 'true'; // New: Persistent hide state
  let cloak = loadJson(LS_KEYS.tabCloak, { title: document.title, icon: '' });
  let updateSourceUrl = localStorage.getItem(LS_KEYS.updateUrl) || defaultUpdateUrl;

  let movieQuery = '';
  let gameQuery = '';
  let currentShowIndex = null;
  let episodeQuery = '';
  let currentSeason = null;

  function applyTheme(t=theme, themeName=currentThemeName){
    const root=document.documentElement;
    root.style.setProperty('--bg-color', t.bgColor || defaultTheme.bgColor);
    root.style.setProperty('--bg-image', t.bgImage && t.bgImage.trim().length>6 ? `url("${t.bgImage}")` : 'none');
    root.style.setProperty('--text-color', t.textColor || defaultTheme.textColor);
    root.style.setProperty('--accent-color', t.accentColor || defaultTheme.accentColor);
    root.style.setProperty('--button-color', t.buttonColor || defaultTheme.buttonColor);
    root.style.setProperty('--effect-color', t.effectColor || defaultTheme.effectColor);
    root.style.setProperty('--nav-active', t.overallThemeColor || t.accentColor || defaultTheme.accentColor);

    // Apply theme class for layout/button variations
    document.body.className = ''; // Reset
    if (themeName) document.body.classList.add(`theme-${themeName}`);
  }

  function presetTheme(name){
    let t={...defaultTheme};
    if(name==='dark'){ t.bgColor='#1E1E2E'; t.textColor='#CDD6F4'; t.accentColor='#CBA6F7'; t.buttonColor='#89B4FA'; t.overallThemeColor='#CBA6F7'; t.effectColor='rgba(203,166,247,0.3)'; t.bgImage=''; }
    else if(name==='halloween'){ t.bgColor='#121212'; t.textColor='#FFEA00'; t.accentColor='#FF7518'; t.buttonColor='#FF4500'; t.overallThemeColor='#8B0000'; t.effectColor='rgba(255,117,24,0.35)'; t.bgImage=''; } // Enhanced: More orange/pumpkin colors, dark spooky base
    else if(name==='christmas'){ t.bgColor='#0C0F14'; t.textColor='#FFFFFF'; t.accentColor='#228B22'; t.buttonColor='#FF0000'; t.overallThemeColor='#C71585'; t.effectColor='rgba(34,139,34,0.35)'; t.bgImage=''; } // Enhanced: Dark snowy base, red/green accents, festive pink for highlights
    else if(name==='nordic-dark'){ t.bgColor='#2E3440'; t.textColor='#D8DEE9'; t.accentColor='#5E81AC'; t.buttonColor='#4C566A'; t.overallThemeColor='#81A1C1'; t.effectColor='rgba(94,129,172,0.3)'; t.bgImage=''; }
    else if(name==='sweet'){ t.bgColor='#2D1B33'; t.textColor='#E0BBE4'; t.accentColor='#957FB8'; t.buttonColor='#DDA0DD'; t.overallThemeColor='#CDA2D0'; t.effectColor='rgba(149,127,184,0.3)'; t.bgImage=''; }
    else if(name==='chrome-os'){ t.bgColor='#202124'; t.textColor='#E8EAED'; t.accentColor='#4285F4'; t.buttonColor='#1A73E8'; t.overallThemeColor='#34A853'; t.effectColor='rgba(66,133,244,0.3)'; t.bgImage=''; } // Dark Chrome OS
    else if(name==='dracula'){ t.bgColor='#282A36'; t.textColor='#F8F8F2'; t.accentColor='#BD93F9'; t.buttonColor='#FF79C6'; t.overallThemeColor='#50FA7B'; t.effectColor='rgba(189,147,249,0.3)'; t.bgImage=''; }
    else if(name==='mandela'){ t.bgColor='#333333'; t.textColor='#FFFFFF'; t.accentColor='#666666'; t.buttonColor='#999999'; t.overallThemeColor='#CCCCCC'; t.effectColor='rgba(102,102,102,0.3)'; t.bgImage=''; }
    theme=t; saveJson(LS_KEYS.theme, theme); localStorage.setItem(LS_KEYS.currentTheme, name); currentThemeName = name; applyTheme(t, name); bindSettingsForm();
  }

  function showPage(id){
    document.querySelectorAll('.nav button').forEach(btn=>btn.classList.toggle('active', btn.dataset.target===id));
    document.querySelectorAll('section.page').forEach(sec=>sec.classList.toggle('active', sec.id===id));
  }

  function renderProfile(){
    document.getElementById('usernameText').textContent = profile.username || 'User';
    document.getElementById('homeUsername').textContent = `Welcome, ${profile.username || 'User'}`;
    document.getElementById('homeDescription').textContent = profile.description || defaultProfile.description;

    const avatarImgEl = document.getElementById('avatarImg');
    const avatarPreviewEl = document.getElementById('avatarPreview');
    const homeAvatarEl = document.getElementById('homeAvatar');
    if(profile.avatarUrl){ avatarImgEl.src=profile.avatarUrl; avatarPreviewEl.src=profile.avatarUrl; homeAvatarEl.src=profile.avatarUrl; }
    else { avatarImgEl.removeAttribute('src'); avatarPreviewEl.removeAttribute('src'); homeAvatarEl.removeAttribute('src'); }

    const homeGenresEl=document.getElementById('homeGenres'); homeGenresEl.innerHTML='';
    const genres = Array.isArray(profile.genres) ? profile.genres : (profile.genres || '').split(',').map(s=>s.trim()).filter(Boolean);
    genres.forEach(g=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=g; homeGenresEl.appendChild(chip); });

    document.getElementById('profileUsername').value = profile.username || '';
    document.getElementById('profileAvatarUrl').value = profile.avatarUrl || '';
    document.getElementById('profileDescription').value = profile.description || '';
    document.getElementById('profileGenres').value = Array.isArray(profile.genres) ? profile.genres.join(', ') : (profile.genres || '');
  }
  function initProfileDropdown(){
    const userIdBtn=document.getElementById('userIdBtn');
    const dropdown=document.getElementById('profileDropdown');
    userIdBtn.addEventListener('click',(e)=>{ if(e.target.closest('.profile-dropdown')) return; dropdown.style.display = dropdown.style.display==='block' ? 'none' : 'block'; });
    document.getElementById('profileCancel').addEventListener('click',()=>{ dropdown.style.display='none'; renderProfile(); });
    document.getElementById('profileSave').addEventListener('click',()=>{
      profile.username=document.getElementById('profileUsername').value.trim() || 'User';
      profile.avatarUrl=document.getElementById('profileAvatarUrl').value.trim();
      profile.description=document.getElementById('profileDescription').value.trim();
      const genresStr=document.getElementById('profileGenres').value.trim();
      profile.genres=genresStr? genresStr.split(',').map(s=>s.trim()).filter(Boolean) : [];
      saveJson(LS_KEYS.profile, profile); renderProfile(); dropdown.style.display='none';
    });
    document.getElementById('profileAvatarUrl').addEventListener('input',(e)=>{ document.getElementById('avatarPreview').src=e.target.value.trim(); });
    document.addEventListener('click',(e)=>{ if(!e.target.closest('#userIdBtn')) dropdown.style.display='none'; });
  }

  let movieEditIndex=null;
  function renderMovies(){
    const grid=document.getElementById('moviesGrid'); grid.innerHTML='';
    const items = movies.filter(m => (m.title || '').toLowerCase().includes(movieQuery.toLowerCase()));
    items.forEach(m=>{
      const idx=movies.indexOf(m);
      const card=document.createElement('div'); card.className='card';
      const thumb=document.createElement('div'); thumb.className='thumb';
      if(m.coverUrl){ const img=document.createElement('img'); img.src=m.coverUrl; thumb.appendChild(img); } else { thumb.textContent=m.title; }
      const mask=document.createElement('div'); mask.className='edit-mask';
      const maskBtn=document.createElement('button'); maskBtn.className='mask-btn'; maskBtn.textContent='Edit Cover';
      maskBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openMovieEditor(idx); });
      mask.appendChild(maskBtn); thumb.appendChild(mask);
      thumb.addEventListener('click',()=>openViewer(m.title, m.driveLink, 'movie'));
      const info=document.createElement('div'); info.className='info';
      const left=document.createElement('div');
      const titleDiv=document.createElement('div'); titleDiv.className='title'; titleDiv.textContent=m.title;
      const sub=document.createElement('div'); sub.className='small muted'; sub.textContent='Click to watch';
      left.appendChild(titleDiv); left.appendChild(sub);
      info.appendChild(left);
      card.appendChild(thumb); card.appendChild(info);
      grid.appendChild(card);
    });
  }
  function openMovieEditor(idx){
    movieEditIndex=idx;
    const modal=document.getElementById('movieEditorModal');
    const titleEl=document.getElementById('editMovieTitle');
    const coverEl=document.getElementById('editMovieCover');
    const linkEl=document.getElementById('editMovieLink');
    const previewImg=document.getElementById('moviePreviewImg');
    if(idx==null){ titleEl.value=''; coverEl.value=''; linkEl.value=''; previewImg.removeAttribute('src'); }
    else { const m=movies[idx]; titleEl.value=m.title||''; coverEl.value=m.coverUrl||''; linkEl.value=m.driveLink||''; if(m.coverUrl) previewImg.src=m.coverUrl; }
    coverEl.oninput=()=>{ const url=coverEl.value.trim(); if(url) previewImg.src=url; else previewImg.removeAttribute('src'); };
    document.getElementById('movieEditCancel').onclick=()=>{ modal.style.display='none'; document.body.classList.remove('no-scroll'); };
    document.getElementById('movieEditSave').onclick=()=>{
      const title=titleEl.value.trim() || 'Untitled';
      const cover=coverEl.value.trim();
      const link=linkEl.value.trim();
      if(movieEditIndex==null) movies.push({ title, coverUrl: cover, driveLink: link });
      else movies[movieEditIndex]={ title, coverUrl: cover, driveLink: link };
      saveJson(LS_KEYS.movies, movies); modal.style.display='none'; document.body.classList.remove('no-scroll'); renderMovies();
    };
    document.getElementById('movieEditDelete').onclick=()=>{
      if(confirm('Delete this movie?')){
        movies.splice(movieEditIndex, 1);
        saveJson(LS_KEYS.movies, movies);
        modal.style.display='none'; document.body.classList.remove('no-scroll'); renderMovies();
      }
    };
    modal.style.display='flex'; document.body.classList.add('no-scroll');
    modal.addEventListener('click',(e)=>{ if(!e.target.closest('.modal-inner')){ modal.style.display='none'; document.body.classList.remove('no-scroll'); } }, { once:true });
  }
  function refreshMovies(){ renderMovies(); }
  function clearMovieSearch(){ movieQuery=''; document.getElementById('movieSearch').value=''; renderMovies(); }
  document.getElementById('movieSearch').addEventListener('input',(e)=>{ movieQuery=e.target.value.trim(); renderMovies(); });

  function renderGames(){
    const list=document.getElementById('gamesList'); list.innerHTML='';
    const items = games.filter(g => g && (g.title || '').toLowerCase().includes(gameQuery.toLowerCase()));
    items.forEach(g=>{
      const idx=games.indexOf(g);
      const item=document.createElement('div'); item.className='list-item';
      const left=document.createElement('div');
      const title=document.createElement('div'); title.className='title'; title.textContent=g.title;
      const muted=document.createElement('div'); muted.className='muted'; muted.textContent=`Local: ${g.src}`;
      left.appendChild(title); left.appendChild(muted);
      const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      const playBtn=document.createElement('button'); playBtn.className='btn btn-primary'; playBtn.textContent='Play';
      playBtn.addEventListener('click',()=>openViewer(g.title, g.src, 'game'));
      const editBtn=document.createElement('button'); editBtn.className='btn btn-secondary'; editBtn.textContent='Edit';
      editBtn.addEventListener('click',()=>editGamePrompt(idx));
      right.appendChild(playBtn); right.appendChild(editBtn);
      item.appendChild(left); item.appendChild(right);
      list.appendChild(item);
    });
  }
  function addGamePrompt(){
    const title=prompt('Game title:'); if(!title) return;
    const src=prompt('Local path to game HTML (e.g., ./games/my-game/index.html):', './games/my-game/index.html');
    games.push({ title, src: src || '', runtime: 'classic' }); saveJson(LS_KEYS.games, games); renderGames();
  }
  function editGamePrompt(idx){
    const g=games[idx];
    const title=prompt('Edit title:', g.title) || g.title;
    const src=prompt('Edit local path:', g.src || '') || g.src;
    games[idx] = { title, src, runtime: 'classic' }; saveJson(LS_KEYS.games, games); renderGames();
  }
  function resetGames(){ if(!confirm('Reset games list to defaults?')) return; games=defaultGames.slice(); saveJson(LS_KEYS.games, games); renderGames(); }
  function clearGameSearch(){ gameQuery=''; document.getElementById('gameSearch').value=''; renderGames(); }
  document.getElementById('gameSearch').addEventListener('input',(e)=>{ gameQuery=e.target.value.trim(); renderGames(); });

  // New: Render shows
  function renderShows(){
    const grid = document.getElementById('showsGrid'); grid.innerHTML = '';
    shows.forEach((show, idx) => {
      const card = document.createElement('div'); card.className = 'card show-card';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      thumb.textContent = show.title; // Could add cover if extended
      thumb.addEventListener('click', () => openShowsModal(idx));
      const info = document.createElement('div'); info.className = 'info';
      const titleDiv = document.createElement('div'); titleDiv.className = 'title'; titleDiv.textContent = show.title;
      info.appendChild(titleDiv);
      card.appendChild(thumb); card.appendChild(info);
      grid.appendChild(card);
    });
  }

  let episodeSearchInput;
  let seasonDropdown;
  function openShowsModal(idx) {
    currentShowIndex = idx;
    const show = shows[idx];
    document.getElementById('showsModalTitle').textContent = show.title;
    episodeQuery = '';
    currentSeason = show.seasons[0]?.season || 1;
    seasonDropdown = document.getElementById('seasonDropdown');
    populateSeasonDropdown(show);
    renderEpisodesGrid();
    const modal = document.getElementById('showsModal');
    modal.style.display = 'flex';
    document.body.classList.add('no-scroll');
    episodeSearchInput = document.getElementById('episodeSearch');
    episodeSearchInput.value = '';
    episodeSearchInput.addEventListener('input', (e) => { episodeQuery = e.target.value.trim(); renderEpisodesGrid(); });
    seasonDropdown.addEventListener('change', (e) => { currentSeason = parseInt(e.target.value); renderEpisodesGrid(); });
    document.getElementById('showsModalClose').onclick = () => { modal.style.display = 'none'; document.body.classList.remove('no-scroll'); };
    modal.addEventListener('click', (e) => { if (!e.target.closest('.modal-inner')) { modal.style.display = 'none'; document.body.classList.remove('no-scroll'); } }, { once: true });
  }

  function populateSeasonDropdown(show) {
    seasonDropdown.innerHTML = '';
    show.seasons.forEach((season) => {
      const option = document.createElement('option'); option.value = season.season; option.textContent = `Season ${season.season}`;
      seasonDropdown.appendChild(option);
    });
    seasonDropdown.value = currentSeason;
  }

  function renderEpisodesGrid() {
    const grid = document.getElementById('episodesGrid'); grid.innerHTML = '';
    const show = shows[currentShowIndex];
    if (!show || !show.seasons) return;
    const selectedSeason = show.seasons.find(s => s.season === currentSeason);
    if (!selectedSeason) return;
    const filteredEpisodes = selectedSeason.episodes.filter(ep => (ep.title || '').toLowerCase().includes(episodeQuery.toLowerCase()));
    filteredEpisodes.forEach((ep) => {
      const card = document.createElement('div'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      if (ep.coverUrl) {
        const img = document.createElement('img'); img.src = ep.coverUrl; thumb.appendChild(img);
      } else {
        thumb.textContent = `E${ep.number}: ${ep.title}`;
      }
      thumb.addEventListener('click', () => openViewer(ep.title, ep.url, 'show'));
      const info = document.createElement('div'); info.className = 'info';
      const titleDiv = document.createElement('div'); titleDiv.className = 'title'; titleDiv.textContent = `E${ep.number}: ${ep.title}`;
      info.appendChild(titleDiv);
      card.appendChild(thumb); card.appendChild(info);
      grid.appendChild(card);
    });
  }
  function clearEpisodeSearch() { episodeQuery = ''; episodeSearchInput.value = ''; renderEpisodesGrid(); }
  function resetShows() { if (!confirm('Reset shows to default?')) return; shows = defaultShows.slice(); saveJson(LS_KEYS.shows, shows); renderShows(); }

  // New: Render proxies dynamically (for merging during updates)
  function renderProxies(){
    const list=document.getElementById('proxiesList'); list.innerHTML='';
    proxies.forEach(p=>{
      const item=document.createElement('div'); item.className='list-item';
      const left=document.createElement('div');
      const title=document.createElement('div'); title.className='title'; title.textContent=p.title;
      const muted=document.createElement('div'); muted.className='muted'; muted.textContent=p.description || '';
      left.appendChild(title); left.appendChild(muted);
      const a=document.createElement('a'); a.href=p.url; a.target='_blank'; a.rel='noopener'; a.textContent='Open';
      item.appendChild(left); item.appendChild(a);
      list.appendChild(item);
    });
  }

  function openViewer(title, src, type){
    document.body.classList.add('no-scroll');
    document.getElementById('overlay').classList.add('open');
    document.getElementById('viewerTitle').textContent = title || 'Viewer';
    const iframe = document.getElementById('viewerIframe');
    iframe.src = 'about:blank'; // Reset
    if (type === 'movie' || type === 'show' && src.includes('drive.google.com')) {
      // Improved embedding for Google Drive
      const fileId = src.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
      if (fileId) {
        iframe.src = `https://drive.google.com/file/d/${fileId}/preview?usp=embed_googleplus`;
      } else {
        iframe.src = src.replace('/view', '/preview');
      }
      iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups');
    } else {
      iframe.src = src || 'about:blank';
    }
    logRecentView(type, title, src);
  }

  function logRecentView(type, title, src) {
    recentViews = recentViews.filter(view => view.title !== title); // Remove if already exists
    recentViews.unshift({ type, title, src });
    if (recentViews.length > 5) recentViews.pop(); // Limit to 5
    saveJson(LS_KEYS.recentViews, recentViews);
    renderRecent();
  }

  function renderRecent() {
    const grid = document.getElementById('recentGrid'); grid.innerHTML = '';
    if (recentViews.length === 0 || recentHidden) {
      grid.style.display = 'none';
      return;
    }
    grid.style.display = 'grid';
    recentViews.forEach((view, idx) => {
      const card = document.createElement('div'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      thumb.textContent = view.title;
      thumb.addEventListener('click', () => openViewer(view.title, view.src, view.type));
      const removeBtn = document.createElement('button'); removeBtn.className = 'remove-btn'; removeBtn.textContent = 'Ã—';
      removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeRecent(idx); });
      thumb.appendChild(removeBtn);
      const info = document.createElement('div'); info.className = 'info';
      const titleDiv = document.createElement('div'); titleDiv.className = 'title'; titleDiv.textContent = view.title;
      const sub = document.createElement('div'); sub.className = 'small muted'; sub.textContent = view.type.charAt(0).toUpperCase() + view.type.slice(1);
      info.appendChild(titleDiv); info.appendChild(sub);
      card.appendChild(thumb); card.appendChild(info);
      grid.appendChild(card);
    });
  }

  function removeRecent(idx) {
    recentViews.splice(idx, 1);
    saveJson(LS_KEYS.recentViews, recentViews);
    renderRecent();
  }

  function toggleRecent(hide) {
    recentHidden = hide;
    localStorage.setItem(LS_KEYS.recentHidden, hide);
    renderRecent();
    document.getElementById('recentDropdown').classList.remove('open');
  }

  function clearAllRecent() {
    if (confirm('Clear all recent views?')) {
      recentViews = [];
      saveJson(LS_KEYS.recentViews, recentViews);
      renderRecent();
      document.getElementById('recentDropdown').classList.remove('open');
    }
  }

  function closeViewer(){
    document.getElementById('overlay').classList.remove('open');
    document.getElementById('viewerIframe').src = 'about:blank';
    document.body.classList.remove('no-scroll');
    const viewer = document.getElementById('viewer');
    viewer.classList.remove('fs');
    if(document.fullscreenElement) document.exitFullscreen().catch(()=>{}); 
  }
  function initOverlayControls(){
    document.getElementById('closeOverlayBtn').addEventListener('click', closeViewer);
    document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
      const viewer=document.getElementById('viewer');
      if(document.fullscreenElement){ document.exitFullscreen(); }
      else{
        if(viewer.requestFullscreen){
          viewer.requestFullscreen().then(()=>{ viewer.classList.add('fs'); }).catch(()=>{ viewer.classList.add('fs'); });
        } else {
          viewer.classList.add('fs');
        }
      }
    });
    document.addEventListener('fullscreenchange',()=>{
      const viewer=document.getElementById('viewer');
      if(document.fullscreenElement===viewer){ viewer.classList.add('fs'); }
      else { viewer.classList.remove('fs'); }
    });
  }

  function bindSettingsForm(){
    document.getElementById('bgColorPicker').value = rgbToHex(theme.bgColor || defaultTheme.bgColor);
    document.getElementById('bgImageUrl').value = theme.bgImage || '';
    document.getElementById('overallThemeColor').value = rgbToHex(theme.overallThemeColor || theme.accentColor || defaultTheme.accentColor);
    document.getElementById('accentColorPicker').value = rgbToHex(theme.accentColor || defaultTheme.accentColor);
    document.getElementById('buttonColorPicker').value = rgbToHex(theme.buttonColor || defaultTheme.buttonColor);
    document.getElementById('textColorPicker').value = rgbToHex(theme.textColor || defaultTheme.textColor);
    document.getElementById('effectColorPicker').value = rgbToHex(extractRGB(theme.effectColor) || '#CBA6F7');
    document.getElementById('presetThemeSelect').value='';
    document.getElementById('tabTitleInput').value = cloak.title || '';
    document.getElementById('tabIconInput').value = cloak.icon || '';
    document.getElementById('viewerWidthInput').value = localStorage.getItem(LS_KEYS.viewerWidth) || '98';
    document.getElementById('viewerHeightInput').value = localStorage.getItem(LS_KEYS.viewerHeight) || '98';
    document.getElementById('panicKeyInput').value = localStorage.getItem(LS_KEYS.panicKey) || 'Escape';
    document.getElementById('panicUrlInput').value = localStorage.getItem(LS_KEYS.panicUrl) || 'https://www.google.com';
    document.getElementById('fontSizeInput').value = localStorage.getItem(LS_KEYS.fontSize) || '16';
    document.getElementById('performanceModeSelect').value = localStorage.getItem(LS_KEYS.performanceMode) || '0';
  }
  function saveSettings(){
    theme.bgColor=document.getElementById('bgColorPicker').value;
    theme.bgImage=document.getElementById('bgImageUrl').value.trim();
    theme.overallThemeColor=document.getElementById('overallThemeColor').value;
    theme.accentColor=document.getElementById('accentColorPicker').value;
    theme.buttonColor=document.getElementById('buttonColorPicker').value;
    theme.textColor=document.getElementById('textColorPicker').value;
    theme.effectColor=hexToRgba(document.getElementById('effectColorPicker').value, 0.3);
    saveJson(LS_KEYS.theme, theme); applyTheme(theme, currentThemeName);

    cloak.title=document.getElementById('tabTitleInput').value.trim() || document.title;
    cloak.icon=document.getElementById('tabIconInput').value.trim();
    saveJson(LS_KEYS.tabCloak, cloak); applyTabCloak();

    localStorage.setItem(LS_KEYS.viewerWidth, document.getElementById('viewerWidthInput').value);
    localStorage.setItem(LS_KEYS.viewerHeight, document.getElementById('viewerHeightInput').value);
    localStorage.setItem(LS_KEYS.panicKey, document.getElementById('panicKeyInput').value);
    localStorage.setItem(LS_KEYS.panicUrl, document.getElementById('panicUrlInput').value);
    localStorage.setItem(LS_KEYS.fontSize, document.getElementById('fontSizeInput').value);
    localStorage.setItem(LS_KEYS.performanceMode, document.getElementById('performanceModeSelect').value);
    applyCustomSettings();
  }
  function resetSettings(){ if(!confirm('Reset settings to default theme?')) return; theme={...defaultTheme}; saveJson(LS_KEYS.theme, theme); localStorage.removeItem(LS_KEYS.currentTheme); currentThemeName = ''; applyTheme(); bindSettingsForm(); }

  function applyTabCloak(){
    if(cloak.title) document.title=cloak.title;
    const link=document.getElementById('dynamic-favicon') || (()=>{ const l=document.createElement('link'); l.rel='icon'; l.id='dynamic-favicon'; document.head.appendChild(l); return l; })();
    if(cloak.icon && cloak.icon.length>3) link.href=cloak.icon; else link.removeAttribute('href');
  }

  function mergeDefaults(existing, defaults, keyField = 'title') {
    const merged = [...existing];
    defaults.forEach(def => {
      if (!existing.some(ex => ex[keyField] === def[keyField])) merged.push(def);
    });
    return merged;
  }

  // New update function: Fetch HTML and rewrite document in place
  function checkForUpdate(userInitiated=false){
    const url=updateSourceUrl;
    if(!url) return;
    fetch(url,{cache:'no-store'})
      .then(res=>{ if(!res.ok) throw new Error('Failed'); return res.text(); })
      .then(html=>{
        const latest=(html.match(/<meta[^>]+name=["']app-version["'][^>]+content=["']([^"']+)["']/i)||[])[1];
        const cur=document.querySelector('meta[name="app-version"]')?.content || '0.0.0';
        if(latest && semverCompare(latest, cur)>0){
          document.getElementById('versionLabel').textContent=`Current ${cur} â†’ Latest ${latest}`;
          const modal=document.getElementById('updateModal'); modal.style.display='flex';
          document.getElementById('updateLaterBtn').onclick=()=>{ modal.style.display='none'; };
          document.getElementById('updateNowBtn').onclick=()=>{
            // Merge defaults before applying update
            movies = mergeDefaults(movies, defaultMovies); saveJson(LS_KEYS.movies, movies);
            games = mergeDefaults(games, defaultGames); saveJson(LS_KEYS.games, games);
            shows = mergeDefaults(shows, defaultShows); saveJson(LS_KEYS.shows, shows);
            proxies = mergeDefaults(proxies, defaultProxies, 'title'); saveJson(LS_KEYS.proxies, proxies);
            modal.style.display='none';

            // Rewrite the document with new HTML (updates in place)
            document.open();
            document.write(html);
            document.close();
          };
        } else {
          if (userInitiated) alert('You are already on the latest version.');
        }
      }).catch(()=>{ if (userInitiated) alert('Failed to check updates. Verify URL and CORS.'); });
  }

  function bindNav(){ document.querySelectorAll('.nav button').forEach(btn=>{ btn.addEventListener('click',()=>showPage(btn.dataset.target)); }); }

  function applyCustomSettings() {
    const root = document.documentElement;
    root.style.setProperty('--viewer-width', (localStorage.getItem(LS_KEYS.viewerWidth) || '98') + 'vw');
    root.style.setProperty('--viewer-height', (localStorage.getItem(LS_KEYS.viewerHeight) || '98') + 'vh');
    root.style.setProperty('--font-size-base', (localStorage.getItem(LS_KEYS.fontSize) || '16') + 'px');
    document.body.classList.toggle('performance-mode', localStorage.getItem(LS_KEYS.performanceMode) === '1');
  }

  // Panic button
  document.addEventListener('keydown', (e) => {
    const panicKey = localStorage.getItem(LS_KEYS.panicKey) || 'Escape';
    const panicUrl = localStorage.getItem(LS_KEYS.panicUrl) || 'https://www.google.com';
    if (e.key === panicKey) {
      window.open(panicUrl, '_blank');
      window.location.href = panicUrl; // Fallback redirect
    }
  });

  // Walkthrough Logic
  function showWalkthroughIfNeeded(){
    const done=localStorage.getItem(LS_KEYS.setupDone)==='true';
    if(!done){
      const modal=document.getElementById('walkthrough'); modal.style.display='flex';
      let currentStep = 0;
      const steps = ['welcome', 'user', 'ui', 'congrats'];
      const backBtn = document.getElementById('walkBack');
      const nextBtn = document.getElementById('walkNext');

      function showStep(step) {
        document.querySelectorAll('.walkthrough-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${steps[step]}`).classList.add('active');
        backBtn.style.display = step === 0 ? 'none' : 'block';
        nextBtn.textContent = step === steps.length - 1 ? 'Finish' : 'Next';
      }

      backBtn.onclick = () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      };

      nextBtn.onclick = () => {
        if (currentStep === 1) { // Save user data
          profile.username = document.getElementById('walkUsername').value.trim() || 'User';
          profile.avatarUrl = document.getElementById('walkAvatarUrl').value.trim();
          profile.description = document.getElementById('walkDescription').value.trim();
          const genresStr = document.getElementById('walkGenres').value.trim();
          profile.genres = genresStr ? genresStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          saveJson(LS_KEYS.profile, profile);
        } else if (currentStep === 2) { // Save UI theme
          theme.bgColor = document.getElementById('walkBg').value;
          theme.bgImage = document.getElementById('walkWallpaper').value.trim();
          theme.overallThemeColor = document.getElementById('walkOverall').value;
          theme.accentColor = document.getElementById('walkAccent').value;
          theme.buttonColor = document.getElementById('walkButton').value;
          theme.textColor = document.getElementById('walkText').value;
          theme.effectColor = hexToRgba(document.getElementById('walkEffect').value, 0.3);
          saveJson(LS_KEYS.theme, theme);
          applyTheme();
        }

        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
        } else {
          localStorage.setItem(LS_KEYS.setupDone, 'true');
          modal.style.display = 'none';
          renderProfile(); // Update home with new profile data
          showPage('home'); // Load home screen
          document.getElementById('updateLog').style.display = 'flex'; // Show update log after walkthrough
        }
      };

      // Instant preview for UI step
      document.getElementById('walkBg').addEventListener('input', (e) => { theme.bgColor = e.target.value; applyTheme(); });
      document.getElementById('walkWallpaper').addEventListener('input', (e) => { theme.bgImage = e.target.value.trim(); applyTheme(); });
      document.getElementById('walkOverall').addEventListener('input', (e) => { theme.overallThemeColor = e.target.value; applyTheme(); });
      document.getElementById('walkAccent').addEventListener('input', (e) => { theme.accentColor = e.target.value; applyTheme(); });
      document.getElementById('walkButton').addEventListener('input', (e) => { theme.buttonColor = e.target.value; applyTheme(); });
      document.getElementById('walkText').addEventListener('input', (e) => { theme.textColor = e.target.value; applyTheme(); });
      document.getElementById('walkEffect').addEventListener('input', (e) => { theme.effectColor = hexToRgba(e.target.value, 0.3); applyTheme(); });

      // Initialize values for UI step
      document.getElementById('walkBg').value = rgbToHex(theme.bgColor);
      document.getElementById('walkWallpaper').value = theme.bgImage;
      document.getElementById('walkOverall').value = rgbToHex(theme.overallThemeColor);
      document.getElementById('walkAccent').value = rgbToHex(theme.accentColor);
      document.getElementById('walkButton').value = rgbToHex(theme.buttonColor);
      document.getElementById('walkText').value = rgbToHex(theme.textColor);
      document.getElementById('walkEffect').value = rgbToHex(extractRGB(theme.effectColor));

      // Initialize user step
      document.getElementById('walkUsername').value = profile.username || '';
      document.getElementById('walkAvatarUrl').value = profile.avatarUrl || '';
      document.getElementById('walkDescription').value = profile.description || '';
      document.getElementById('walkGenres').value = Array.isArray(profile.genres) ? profile.genres.join(', ') : (profile.genres || '');

      showStep(currentStep);
    } else {
      // If setup done, show update log on home load
      document.getElementById('updateLog').style.display = 'flex';
    }
  }

  function init(){
    applyTheme(theme, currentThemeName);
    applyTabCloak();
    renderProfile();
    initProfileDropdown();
    bindNav();
    renderMovies();
    renderGames();
    renderShows(); // New: Render shows
    renderProxies(); // New: Render proxies
    renderRecent(); // New: Render recent on init
    bindSettingsForm();
    initOverlayControls();
    applyCustomSettings();

    // Show walkthrough or update log
    showWalkthroughIfNeeded();

    const presetSelect = document.getElementById('presetThemeSelect');
    if (presetSelect) {
      presetSelect.addEventListener('change', (e) => {
        const name = e.target.value;
        if (!name) return;
        presetTheme(name);
        e.target.value = '';
      });
    }

    document.getElementById('applyTabCloakBtn').addEventListener('click',()=>{ cloak.title=document.getElementById('tabTitleInput').value.trim() || cloak.title; cloak.icon=document.getElementById('tabIconInput').value.trim(); saveJson(LS_KEYS.tabCloak, cloak); applyTabCloak(); });
    document.getElementById('cloakGoogleBtn').addEventListener('click',()=>{ cloak={ title:'Google', icon:'https://www.google.com/favicon.ico' }; saveJson(LS_KEYS.tabCloak, cloak); bindSettingsForm(); applyTabCloak(); });
    document.getElementById('cloakCanvasBtn').addEventListener('click',()=>{ cloak={ title:'Canvas', icon:'https://ccisd.instructure.com/favicon.ico' }; saveJson(LS_KEYS.tabCloak, cloak); bindSettingsForm(); applyTabCloak(); });
    document.getElementById('resetCloakBtn').addEventListener('click',()=>{ cloak={ title:'Media Hub', icon:'' }; saveJson(LS_KEYS.tabCloak, cloak); bindSettingsForm(); applyTabCloak(); });

    document.getElementById('closeLogBtn').addEventListener('click', () => { document.getElementById('updateLog').style.display = 'none'; });
    document.getElementById('recentMenuBtn').addEventListener('click', () => { document.getElementById('recentDropdown').classList.toggle('open'); });
    document.addEventListener('click', (e) => { if (!e.target.closest('#recentMenuBtn') && !e.target.closest('#recentDropdown')) document.getElementById('recentDropdown').classList.remove('open'); });
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
