<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hallows Eve — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000;
    --text:#fff;
    --muted:rgba(255,255,255,0.6);
    --accent:#7cffb2;
    --card-w:160px;
    --card-h:240px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); overflow:hidden; -webkit-font-smoothing:antialiased;}
  /* background container (gif or image) */
  #bgContainer{ position:fixed; inset:0; z-index:-2; background:#000; background-size:cover; background-position:center; background-repeat:no-repeat; transition:opacity .3s ease;}
  #bgOverlay{ position:fixed; inset:0; background:linear-gradient(rgba(0,0,0,.2), rgba(0,0,0,.45)); z-index:-1;}
  /* app layout */
  #app{ display:flex; height:100vh; width:100vw; }
  /* taskbar left (minimal / semi-invisible) */
  #taskbar{ width:64px; display:flex; flex-direction:column; align-items:center; gap:12px; padding:14px 6px; border-right:1px solid rgba(255,255,255,0.06); background:transparent; z-index:20; }
  .logo{ width:40px; height:40px; border-radius:8px; background:#ffffff12; display:flex; align-items:center; justify-content:center; color:var(--text); font-weight:700; }
  .task-icon{ width:100%; display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--text); font-size:0.78rem; cursor:pointer; opacity:.95; transition:transform .18s, color .18s; text-decoration:none; }
  .task-icon img{ width:28px; height:28px; filter:invert(1) grayscale(.2) brightness(1.1); }
  .task-icon:hover{ transform:scale(1.08); color:var(--accent); }
  .task-label{ display:none; font-weight:600; margin-top:-6px; font-size:0.72rem; color:var(--text); }
  /* main column */
  #mainCol{ flex:1; display:flex; flex-direction:column; position:relative; }
  /* header area (top) */
  header{ height:86px; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; gap:12px; border-bottom:1px solid rgba(255,255,255,.04); }
  #homeClock{ text-align:center; width:100%; position:absolute; left:0; top:6px; font-size:0.95rem; color:var(--muted); pointer-events:none; }
  .leftHeader{ display:flex; align-items:center; gap:12px; }
  h1{ margin:0; font-size:1.4rem; letter-spacing:0.14rem; }
  .header-actions{ display:flex; align-items:center; gap:10px; }
  .btn{ background:transparent; border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:8px; color:var(--text); cursor:pointer; font-weight:600; transition:all .18s; }
  .btn.primary{ background:var(--text); color:#000; }
  .icon-btn{ background:transparent; border:0; color:var(--text); cursor:pointer; font-size:18px; padding:6px; border-radius:8px; }
  /* pages */
  .pages{ position:relative; height:calc(100vh - 86px); display:block; overflow:hidden; }
  .page{ position:absolute; inset:0; padding:22px; display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:flex-start; opacity:0; pointer-events:none; transition:opacity .32s ease, transform .32s ease; transform:translateY(8px); overflow:hidden; }
  .page.active{ opacity:1; pointer-events:auto; transform:none; }
  /* home */
  #home{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; text-align:center; }
  #updateLog{ width:520px; max-width:92%; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.6); }
  #updateLog h3{ margin:0 0 8px 0; font-size:1.05rem; }
  #updateText{ color:var(--muted); font-size:0.92rem; }
  #homeHeader{ font-size:2.6rem; letter-spacing:0.2rem; margin-top:6px; }
  /* search top on movies/games */
  .pageTop{ width:100%; max-width:1200px; display:flex; gap:12px; align-items:center; justify-content:center; margin:6px auto 0; }
  .search{ flex:1; max-width:900px; display:flex; align-items:center; gap:8px; }
  .search input{ width:100%; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text); outline:none; }
  /* gallery list (not tiled) - vertical list with cover + title below */
  .list{ width:100%; max-width:1200px; display:flex; flex-direction:column; gap:12px; padding:14px; overflow:auto; }
  .itemRow{ display:flex; gap:12px; align-items:center; background:rgba(255,255,255,0.02); padding:12px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.45); }
  .coverWrap{ width:var(--card-w); height:var(--card-h); border-radius:12px; overflow:hidden; position:relative; flex:0 0 auto; box-shadow:0 8px 22px rgba(0,0,0,.6); }
  .coverWrap img{ width:100%; height:100%; object-fit:cover; display:block; }
  .cardActions{ position:absolute; top:8px; right:8px; display:flex; gap:8px; }
  .dotsBtn{ width:34px; height:34px; border-radius:8px; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text); border:1px solid rgba(255,255,255,0.04); }
  .starBtn{ width:34px; height:34px; border-radius:8px; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--muted); border:1px solid rgba(255,255,255,0.04); transition:all .18s; }
  .starBtn.bookmarked{ color:var(--accent); box-shadow:0 6px 18px rgba(124,255,178,0.08); filter:drop-shadow(0 6px 18px rgba(124,255,178,0.08)); transform:scale(1.06); }
  .meta{ display:flex; flex-direction:column; gap:8px; }
  .title{ font-weight:700; font-size:1.05rem; }
  .descr{ color:var(--muted); font-size:0.92rem; max-width:820px; }
  .rowBtns{ display:flex; gap:10px; margin-left:auto; }
  .rowBtns .btn{ padding:8px 12px; }
  /* modal editor per item */
  .editor{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#0b0b0b; border:1px solid rgba(255,255,255,0.08); padding:14px; border-radius:12px; width:480px; max-width:94%; z-index:1200; display:none; box-shadow:0 18px 60px rgba(0,0,0,.6); }
  .editor.show{ display:block; animation:pop .18s ease both; }
  @keyframes pop{ from{opacity:0; transform:translate(-50%,-46% ) scale(.98)} to{opacity:1; transform:translate(-50%,-50%) scale(1)} }
  .editor h4{ margin:0 0 8px 0; }
  .editor label{ font-size:0.9rem; color:var(--muted); display:block; margin-bottom:6px; }
  .editor input[type="text"], .editor textarea, .editor input[type="url"]{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text); outline:none; }
  .editor input[type="file"]{ color:var(--muted); }
  .editor .editor-row{ display:flex; gap:8px; margin-top:8px; }
  .editor .small{ flex:1; }
  /* settings panel slide from left under header */
  #settingsPanel{ position:fixed; left:10px; top:86px; width:360px; max-width:92%; background:rgba(11,11,11,.98); border:1px solid rgba(255,255,255,0.06); padding:14px; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.6); z-index:1100; transform:translateX(-8px); display:none; }
  #settingsPanel.show{ display:block; animation:slidein .18s ease both; }
  @keyframes slidein{ from{opacity:0; transform:translateX(-20px)} to{opacity:1; transform:none} }
  .settings-row{ margin-bottom:10px; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  /* overlay player */
  #overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1300; background:rgba(0,0,0,0.92); padding:20px; }
  #overlay.show{ display:flex; animation:overlayin .18s ease both; }
  @keyframes overlayin{ from{opacity:0} to{opacity:1} }
  #playerCard{ width:94%; height:88%; background:#000; border-radius:12px; position:relative; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 28px 80px rgba(0,0,0,0.7); }
  #playerFrame{ width:100%; height:100%; border:0; background:#000; }
  .playerTop{ position:absolute; right:12px; top:12px; display:flex; gap:8px; z-index:10; }
  .closeOverlayBtn{ background:rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px; border:0; color:var(--text); cursor:pointer; }
  /* small responsive */
  @media (max-width:900px){
    .list{ padding:10px; }
    .itemRow{ flex-direction:column; align-items:flex-start; }
    .rowBtns{ width:100%; justify-content:flex-end; }
    header{ padding:10px; }
    .coverWrap{ width:46vw; height:64vw; }
  }
</style>
</head>
<body>
  <div id="bgContainer"></div>
  <div id="bgOverlay"></div>

  <div id="app">
    <!-- Taskbar -->
    <aside id="taskbar" aria-hidden="false">
      <div class="logo">HE</div>
      <div class="task-icon" data-page="home" id="btnHome" title="Home">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='white'><path d='M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z'/></svg>">
        <div class="task-label">Home</div>
      </div>
      <div class="task-icon" data-page="movies" id="btnMovies" title="Movies">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='white'><path d='M18 4l3 6H3l3-6h12zM2 11h20v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9z'/></svg>">
        <div class="task-label">Movies</div>
      </div>
      <div class="task-icon" data-page="games" id="btnGames" title="Games">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='white'><path d='M19 7H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h4v-2H7V9h10v6h-2v2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM9 13H7v2h2v-2zm6 0h-2v2h2v-2z'/></svg>">
        <div class="task-label">Games</div>
      </div>

      <div style="flex:1"></div>

      <div class="task-icon" id="btnSettingsToggle" title="Settings">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='white'><path d='M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zM19.4 12a7.4 7.4 0 0 0-.1-1l2-1.6-2-3.4-2.4.7c-.5-.4-1-.7-1.6-.9L15 2h-6l-.8 3.7c-.6.2-1.1.5-1.6.9L4.2 6l-2 3.4 2 1.6c0 .3-.1.7-.1 1s.1.7.1 1l-2 1.6L4 19.4l2.4-.7c.5.4 1 .7 1.6.9L9 22h6l.8-3.7c.6-.2 1.1-.5 1.6-.9l2.4.7 2-3.4-2-1.6c.1-.3.1-.7.1-1z'/></svg>">
        <div class="task-label">Options</div>
      </div>
    </aside>

    <!-- Main Column -->
    <div id="mainCol">
      <header>
        <div class="leftHeader">
          <div id="homeClock" aria-hidden="false"></div>
          <h1 id="headerTitle">HALLOWS EVE</h1>
        </div>
        <div class="header-actions">
          <button class="btn" id="goHomeTop">Home</button>
          <button class="btn" id="goMoviesTop">Movies</button>
          <button class="btn" id="goGamesTop">Games</button>
          <button class="icon-btn" id="openSettingsBtn" title="Open settings">⚙️</button>
        </div>
      </header>

      <main class="pages">
        <section id="home" class="page active" aria-hidden="false">
          <div style="height:12px"></div>
          <div id="updateLog">
            <h3>Update Log — Oct 29, 2025</h3>
            <div id="updateText">•Updated the Ui,Fixed Movies not loading,added auto updates</div>
          </div>
          <div id="homeHeader">Welcome to Hallows Eve</div>
          <div class="muted" style="max-width:820px; text-align:center;">Use the Movies and Games pages to browse. Click a card's 3-dots to edit cover/description. Click the star to bookmark (bookmarks appear on top).</div>
        </section>

        <section id="movies" class="page" aria-hidden="true">
          <div class="pageTop">
            <div class="search">
              <input id="searchMovies" placeholder="Search movies..." />
            </div>
          </div>
          <div class="list" id="moviesList" tabindex="0"></div>
        </section>

        <section id="games" class="page" aria-hidden="true">
          <div class="pageTop">
            <div class="search">
              <input id="searchGames" placeholder="Search games..." />
            </div>
          </div>
          <div class="list" id="gamesList" tabindex="0"></div>
        </section>
      </main>
    </div>
  </div>

  <div id="settingsPanel" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
      <strong>Settings</strong>
      <div>
        <button class="btn" id="closeSettings">Close</button>
      </div>
    </div>
    <div class="settings-row">
      <label class="muted">Background URL</label>
      <input id="bgUrl" type="url" placeholder="Image or GIF URL (or leave blank)">
    </div>
    <div class="settings-row">
      <label class="muted">Upload Background File (image / gif / mp4)</label>
      <input id="bgFile" type="file" accept="image/*,video/*" />
      <div style="display:flex; gap:6px; margin-top:8px;">
        <button class="btn" id="removeBgFile">Remove uploaded background</button>
      </div>
    </div>
    <div class="settings-row">
      <label class="muted">Text color (updates buttons & labels)</label>
      <input id="textColor" type="color" value="#ffffff" />
    </div>
    <div class="settings-row">
      <label class="muted">Auto-update from Drive (simulated)</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="autoUpdate" type="checkbox" />
        <button class="btn" id="checkUpdate">Check for update</button>
      </div>
    </div>
  </div>

  <div id="itemEditor" class="editor" aria-hidden="true">
    <h4 id="editorTitle">Edit item</h4>
    <label class="muted">Title</label>
    <input id="editorTitleInput" type="text" />
    <label class="muted">Description</label>
    <textarea id="editorDesc" rows="3"></textarea>

    <label class="muted" style="margin-top:8px;">Cover image URL</label>
    <input id="editorCoverUrl" type="url" placeholder="Paste image URL">

    <label class="muted" style="margin-top:8px;">Or upload cover file</label>
    <input id="editorCoverFile" type="file" accept="image/*">

    <div class="editor-row" style="margin-top:10px;">
      <button class="btn primary" id="saveItem">Save</button>
      <button class="btn" id="removeCover">Remove cover</button>
      <button class="btn" id="closeEditor">Close</button>
    </div>

    <hr style="opacity:.06;margin:10px 0;">
    <div id="movieSettingsArea" style="display:none;">
      <label class="muted">Mirrors (one per line — placeholder links)</label>
      <textarea id="editorMirrors" rows="3" placeholder="https://drive.google.com/.../preview"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" id="saveMirrors">Save mirrors</button>
      </div>
    </div>
  </div>

  <div id="overlay" aria-hidden="true">
    <div id="playerCard">
      <div class="playerTop">
        <button class="closeOverlayBtn" id="overlayOpenInTab">↗</button>
        <button class="closeOverlayBtn" id="overlayFullscreen">⛶</button>
        <button class="closeOverlayBtn" id="overlayClose">✕</button>
      </div>
      <iframe id="playerFrame" allow="autoplay; fullscreen; picture-in-picture; encrypted-media" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>
  </div>

<script>
const STORAGE_KEY = 'hallows-eve:v2';
const defaults = {
  textColor:'#ffffff',
  background:{ url:'', fileData:'', isFile:false },
  autoUpdate:false,
  pages:{
    movies:[
      { id:'m1', title:'Nightmare On Elm Street', cover:'https://imgc.allpostersimages.com/img/posters/a-nightmare-on-elm-street-one-sheet_u-l-fac4410.jpg', coverIsData:false, desc:'A classic horror film.', mirrors:['https://drive.google.com/file/d/1I8o1GaH9-0qMZYuHPj_yGMUw-zTdQS0n/preview'], url:'' , bookmarked:false },
      { id:'m2', title:'Insidious (Placeholder)', cover:'', coverIsData:false, desc:'Scary things happen.', mirrors:['https://drive.google.com/file/d/PLACEHOLDER/preview'], url:'', bookmarked:false },
      { id:' m3', title:'guh', cover:'', coverIsData:false, desc:'A classic horror film.', mirrors:['https://drive.google.com/file/d/1I8o1GaH9-0qMZYuHPj_yGMUw-zTdQS0n/preview'], url:'' , bookmarked:false },
      { id:' m4', title:'guh2', cover:'', coverIsData:false, desc:'A classic horror film.', mirrors:['https://drive.google.com/file/d/1I8o1GaH9-0qMZYuHPj_yGMUw-zTdQS0n/preview'], url:'' , bookmarked:false }
    ],
    games:[
      { id:'g1', title:'Friday Night Funkin', cover:'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/favicon.png', coverIsData:false, desc:'A fun rhythm game', html:'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/index.html', bookmarked:true },
      { id:'g2', title:'Placeholder Game', cover:'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/favicon.png', coverIsData:false, desc:'Simple HTML game placeholder', html:'https://cdn.jsdelivr.net/gh/genizy/fridayfunk/index.html', bookmarked:false }
    ]
  }
};

let store = loadStorage();

/* deep merge user store into defaults */
function loadStorage() {
const stored = JSON.parse(localStorage.getItem("hallows-eve:v2")) ||
{};
// Iterate over pages (movies, games, etc.)
for (const pageKey in defaults.pages) {
const defaultItems = defaults.pages[pageKey];
const storedItems = stored.pages?.[pageKey] || [];
// Build a map of existing IDs to avoid duplicates
const existingIds = new Set(storedItems.map(item => item.id));
// Append only new items from defaults
const mergedItems = [
...storedItems,
...defaultItems.filter(item => !existingIds.has(item.id))
];
// Assign back to stored.pages
if (!stored.pages) stored.pages = {};
stored.pages[pageKey] = mergedItems;
}
// Save merged result back to localStorage
localStorage.setItem("hallows-eve:v2", JSON.stringify(stored));
return stored;
}

function saveStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

function merge(base, override){
  const out = JSON.parse(JSON.stringify(base));
  function rec(a,b){ for(const k in b){ if(b[k] && typeof b[k]==='object' && !Array.isArray(b[k])){ a[k]=a[k]||{}; rec(a[k],b[k]); } else { a[k]=b[k]; } } }
  rec(out, override); return out;
}

/* -------------------------
   DOM refs
   ------------------------- */
const pages = { home: document.getElementById('home'), movies: document.getElementById('movies'), games: document.getElementById('games') };
const btnHome = document.getElementById('btnHome'), btnMovies = document.getElementById('btnMovies'), btnGames = document.getElementById('btnGames');
const goHomeTop = document.getElementById('goHomeTop'), goMoviesTop = document.getElementById('goMoviesTop'), goGamesTop = document.getElementById('goGamesTop');
const searchMovies = document.getElementById('searchMovies'), searchGames = document.getElementById('searchGames');
const moviesList = document.getElementById('moviesList'), gamesList = document.getElementById('gamesList');
const settingsPanel = document.getElementById('settingsPanel'), openSettingsBtn = document.getElementById('openSettingsBtn'), btnSettingsToggle = document.getElementById('btnSettingsToggle');
const closeSettingsBtn = document.getElementById('closeSettings'), bgUrlIn = document.getElementById('bgUrl'), bgFileIn = document.getElementById('bgFile'), removeBgFileBtn = document.getElementById('removeBgFile');
const textColorIn = document.getElementById('textColor'), autoUpdateIn = document.getElementById('autoUpdate'), checkUpdateBtn = document.getElementById('checkUpdate');
const homeClock = document.getElementById('homeClock'), headerTitle = document.getElementById('headerTitle');
const bgContainer = document.getElementById('bgContainer');

const itemEditor = document.getElementById('itemEditor'), editorTitle = document.getElementById('editorTitle'), editorTitleInput = document.getElementById('editorTitleInput'), editorDesc = document.getElementById('editorDesc');
const editorCoverUrl = document.getElementById('editorCoverUrl'), editorCoverFile = document.getElementById('editorCoverFile'), saveItemBtn = document.getElementById('saveItem'), removeCoverBtn = document.getElementById('removeCover'), closeEditorBtn = document.getElementById('closeEditor');
const movieSettingsArea = document.getElementById('movieSettingsArea'), editorMirrors = document.getElementById('editorMirrors'), saveMirrorsBtn = document.getElementById('saveMirrors');

const overlay = document.getElementById('overlay'), playerFrame = document.getElementById('playerFrame'), overlayClose = document.getElementById('overlayClose'), overlayFullscreen = document.getElementById('overlayFullscreen'), overlayOpenInTab = document.getElementById('overlayOpenInTab');

/* state */
let currentPage = 'home';
let editingItem = null; // { type:'movies'|'games', id:... }

/* -------------------------
   Utilities
   ------------------------- */
function $(sel, ctx=document) { return ctx.querySelector(sel); }
function on(el, ev, fn){ el.addEventListener(ev, fn); }
function formatDate(){ const d=new Date(); return d.toLocaleString('en-US', {timeZone:'America/Chicago', month:'short', day:'numeric', year:'numeric'}); }
function updateClock(){ const now=new Date().toLocaleTimeString('en-US', {timeZone:'America/Chicago', hour:'2-digit', minute:'2-digit', second:'2-digit'}); homeClock.textContent = now; }
setInterval(updateClock,1000); updateClock();

/* -------------------------
   Page switching with fade animation
   ------------------------- */
function showPage(name){
  if(name===currentPage) return;
  const from = pages[currentPage], to = pages[name];
  if(!to) return;
  // fade out
  from.classList.remove('active');
  setTimeout(()=>{ to.classList.add('active'); }, 180);
  currentPage = name;
  // set aria hidden
  for(const k in pages) pages[k].setAttribute('aria-hidden', k!==name);
}
[btnHome, goHomeTop].forEach(b=>b.addEventListener('click', ()=>showPage('home')));
[btnMovies, goMoviesTop].forEach(b=>b.addEventListener('click', ()=>showPage('movies')));
[btnGames, goGamesTop].forEach(b=>b.addEventListener('click', ()=>showPage('games')));

/* -------------------------
   Apply theme/background/text color from store
   ------------------------- */
function applyTheme() {
document.documentElement.style.setProperty('--text', store.textColor ||
defaults.textColor);
const clr = store.textColor || defaults.textColor;
document.querySelectorAll('.btn, .icon-btn, .task-label').forEach(el =>
{
el.style.color = clr;
});
applyBackground(); // call background application
}
function applyBackground() {
if (store.background && store.background.isFile &&
store.background.fileData) {
bgContainer.style.background = `url('${store.background.fileData}')
center/cover no-repeat`;
} else if (store.background && store.background.url) {
const url = store.background.url;
if (url.match(/\.(mp4|webm)$/i)) {
if (!bgContainer._videoEl) {
const v = document.createElement('video');
v.autoplay = true; v.loop = true; v.muted = true; v.playsInline =
true;
v.style.width='100%'; v.style.height='100%';
v.style.objectFit='cover';
bgContainer.appendChild(v); bgContainer._videoEl = v;
}
bgContainer._videoEl.src = url;
bgContainer.style.background = '';
} else {
if (bgContainer._videoEl) {
bgContainer._videoEl.pause();
bgContainer._videoEl.remove();
bgContainer._videoEl = null;
}
bgContainer.style.background = `url('${url}') center/cover no-
repeat`;
bgContainer.style.backgroundSize = 'cover';
}
} else {
if (bgContainer._videoEl) {
bgContainer._videoEl.pause();
bgContainer._videoEl.remove();
bgContainer._videoEl = null;
}
bgContainer.style.background = '#000';
}
}


/* -------------------------
   Settings logic (bg/text color/auto-update)
   ------------------------- */
// SETTINGS PANEL SCRIPT

function toggleSettings() {
settingsPanel.classList.toggle('show');
settingsPanel.setAttribute('aria-hidden',
!settingsPanel.classList.contains('show'));
}
// Text color
textColorIn.addEventListener('input', (e) => {
store.textColor = e.target.value;
applyTheme();
saveStorage();
});
// Background URL
bgUrlIn.addEventListener('input', (e) => {
store.background.isFile = false;
store.background.url = e.target.value;
applyBackground();
saveStorage();
});
// Background file upload
bgFileIn.addEventListener('change', async (e) => {
const file = e.target.files[0];
if (!file) return;
store.background.isFile = true;
store.background.fileData = await fileToDataURL(file);
applyBackground();
saveStorage();
});
removeBgFileBtn.addEventListener('click', () => {
store.background = { url:'', fileData:'', isFile:false };
applyBackground();
saveStorage();
bgFileIn.value = '';
bgUrlIn.value = '';
});
// Auto-update
autoUpdateIn.addEventListener('change', (e) => {
store.autoUpdate = e.target.checked;
saveStorage();
});
// Wire the update button to fetch and merge new data
checkUpdateBtn.addEventListener('click', async () => {
    checkUpdateBtn.disabled = true;
    checkUpdateBtn.textContent = 'Updating...';
    try {
        await updateData(true); // manual = true shows alert on success/failure
        renderAll(); // re-render lists after update
    } catch (err) {
        console.error(err);
    } finally {
        checkUpdateBtn.disabled = false;
        checkUpdateBtn.textContent = 'Check for update';
    }
});

// Toggle via buttons
[btnSettingsToggle, openSettingsBtn].forEach(b =>
b.addEventListener('click', toggleSettings));
closeSettingsBtn.addEventListener('click', toggleSettings);







/* -------------------------
   Render lists (movies/games)
   ------------------------- */
function renderAll(){
  applyTheme();
  renderList('movies');
  renderList('games');
}
function sortedItems(list){
  // bookmarked first, preserve order
  const bk = list.filter(i=>i.bookmarked);
  const rest = list.filter(i=>!i.bookmarked);
  return bk.concat(rest);
}
function createItemRow(type, item){
  const row = document.createElement('div'); row.className='itemRow'; row.dataset.id = item.id;
  // cover
  const coverWrap = document.createElement('div'); coverWrap.className='coverWrap';
  const img = document.createElement('img');
img.src = getCoverUrl(item);

// In-memory storage for previews (won't persist across reloads)
const previewImages = {};

  coverWrap.appendChild(img);
  // action icons
  const actions = document.createElement('div'); actions.className='cardActions';
  const dots = document.createElement('div'); dots.className='dotsBtn'; dots.title='Edit cover / settings'; dots.innerHTML = '&#8942;'; // vertical dots
  dots.addEventListener('click', (e)=>{ e.stopPropagation(); openEditor(type, item.id); });
  const star = document.createElement('div'); star.className='starBtn'; star.title='Bookmark';
  star.innerHTML = '☆';
  if(item.bookmarked) { star.classList.add('bookmarked'); star.innerHTML='★'; }
  star.addEventListener('click', (e)=>{ e.stopPropagation(); toggleBookmark(type, item.id); });
  actions.appendChild(dots); actions.appendChild(star);
  coverWrap.appendChild(actions);
  // meta
  const meta = document.createElement('div'); meta.className='meta';
  const t = document.createElement('div'); t.className='title'; t.textContent = item.title || '(untitled)';
  const d = document.createElement('div'); d.className='descr'; d.textContent = item.desc || '';
  meta.appendChild(t); meta.appendChild(d);
  // buttons
  const rowBtns = document.createElement('div'); rowBtns.className='rowBtns';
  const launch = document.createElement('button'); launch.className='btn primary'; launch.textContent='Launch';
  launch.addEventListener('click', ()=> openLaunch(type, item.id));
  const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit';
  edit.addEventListener('click', ()=> openEditor(type, item.id));
  rowBtns.appendChild(edit); rowBtns.appendChild(launch);

  row.appendChild(coverWrap);
  row.appendChild(meta);
  row.appendChild(rowBtns);
  return row;
}
function renderList(type){
  const container = type==='movies'?moviesList:gamesList;
  container.innerHTML='';
  const items = sortedItems(store.pages[type]);
  items.forEach(item=>{
    // filter by search
    const q = (type==='movies'?searchMovies.value:searchGames.value).trim().toLowerCase();
    if(q && !((item.title||'').toLowerCase().includes(q) || (item.desc||'').toLowerCase().includes(q))) return;
    const row = createItemRow(type, item);
    container.appendChild(row);
  });
}

/* -------------------------
   Search inputs
   ------------------------- */
searchMovies.addEventListener('input', ()=> renderList('movies'));
searchGames.addEventListener('input', ()=> renderList('games'));

/* -------------------------
   Bookmark toggling
   ------------------------- */
function toggleBookmark(type, id){
  const items = store.pages[type];
  const it = items.find(x=>x.id===id);
  if(!it) return;
  it.bookmarked = !it.bookmarked;
  saveStorage(); renderList(type);
}

/* -------------------------
   Editor functions
   ------------------------- */
/* -------------------------
   Item editor logic
   ------------------------- */
function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error("Failed to read file"));
    reader.readAsDataURL(file);
  });
}

let currentCoverFile = null;

function openEditor(type, id) {
  editingItem = { type, id };
  const item = store.pages[type].find(x => x.id === id);
  if (!item) return;

  itemEditor.classList.add('show');
  itemEditor.setAttribute('aria-hidden', 'false');
  editorTitleInput.value = item.title || '';
  editorDesc.value = item.desc || '';
  editorCoverUrl.value = item.coverIsData ? '' : (item.cover || '');
  editorMirrors.value = (item.mirrors || []).join('\n');
  movieSettingsArea.style.display = type === 'movies' ? 'block' : 'none';

  // Reset file input
  editorCoverFile.value = '';
}
editorCoverFile.addEventListener('change', async () => {
  const file = editorCoverFile.files[0];
  if (!file || !editingItem) return;

  const { type, id } = editingItem;
  const item = store.pages[type].find(x => x.id === id);
  if (!item) return;

  // Directly trigger download (optional)
  const a = document.createElement('a');
  a.href = URL.createObjectURL(file);
  a.download = file.name || 'cover.png';
  a.click();
  URL.revokeObjectURL(a.href);

  // Update preview only, do NOT store in localStorage
  const reader = new FileReader();
  reader.onload = () => {
    item.cover = reader.result;  // preview
    item.coverIsData = true;     // only for UI preview
    const listEl = type === 'movies' ? moviesList : gamesList;
    const imgEl = listEl.querySelector(`.itemRow[data-id="${id}"] img`);
    if (imgEl) imgEl.src = reader.result;
  };
  reader.readAsDataURL(file);

  // Reset file input for next upload
  editorCoverFile.value = '';
});

saveItemBtn.addEventListener('click', async () => {
  if (!editingItem) return;

  const { type, id } = editingItem;
  const item = store.pages[type].find(x => x.id === id);
  if (!item) return; // <-- safe check

  // Update text
  item.title = editorTitleInput.value.trim();
  item.desc = editorDesc.value.trim();

  // Prioritize file input
  const file = editorCoverFile.files[0];
  if (file) {
    item.cover = await fileToDataURL(file);
    item.coverIsData = true;
  } 
  // Fallback to URL input
  else if (editorCoverUrl.value.trim()) {
    item.cover = editorCoverUrl.value.trim();
    item.coverIsData = false;
  }

  // Save and re-render
  saveStorage();
  renderList(type);

  // Close editor
  itemEditor.classList.remove('show');
  itemEditor.setAttribute('aria-hidden', 'true');

  // Reset file input
  editorCoverFile.value = '';
  editingItem = null;
});


removeCoverBtn.addEventListener('click', ()=>{
  if(!editingItem) return;
  const { type, id } = editingItem;
  const item = store.pages[type].find(x=>x.id===id);
  if(!item) return;
  item.cover = '';
  item.coverIsData = false;
  saveStorage();
  renderAll();
});

closeEditorBtn.addEventListener('click', ()=>{
  itemEditor.classList.remove('show');
  itemEditor.setAttribute('aria-hidden','true');
});


/* -------------------------
   Opening launch overlay
   ------------------------- */
function openLaunch(type, id){
  const list = store.pages[type];
  const it = list.find(x=>x.id===id);
  if(!it) return;
  // Build a small modal panel that centers (we reuse overlay)
  // but before launching allow user to choose mirror (movies) or just use game's html.
  // We'll show a confirm-like prompt with details; implement simple in-page prompt via editor-like modal:
  buildLaunchPrompt(type, it);
}

function buildLaunchPrompt(type, item){
  // create temporary modal with cover, desc, mirrors selector and launch button
  const prompt = document.createElement('div');
  prompt.style.position='fixed';
  prompt.style.left='50%'; prompt.style.top='50%'; prompt.style.transform='translate(-50%,-50%)';
  prompt.style.width='720px'; prompt.style.maxWidth='94%'; prompt.style.zIndex=1250;
  prompt.style.background='#071012'; prompt.style.border='1px solid rgba(255,255,255,0.06)'; prompt.style.borderRadius='12px';
  prompt.style.padding='14px'; prompt.style.boxShadow='0 28px 60px rgba(0,0,0,.6)';
  // content
  const title = document.createElement('h3'); title.textContent = item.title; title.style.margin='0 0 8px 0';
  const container = document.createElement('div'); container.style.display='flex'; container.style.gap='12px'; container.style.alignItems='flex-start';
  const cov = document.createElement('div'); cov.style.width='220px'; cov.style.height='320px'; cov.style.borderRadius='10px'; cov.style.overflow='hidden';
  const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
  img.src = getCoverUrl(item, 220, 320);
  cov.appendChild(img);
  const info = document.createElement('div'); info.style.flex='1';
  const desc = document.createElement('div'); desc.textContent = item.desc || 'No description.'; desc.style.color='var(--muted)'; desc.style.marginBottom='8px';
  info.appendChild(desc);

  // mirror selector for movies
  let mirrorSelect = null;
  if(type==='movies'){
    const label = document.createElement('div'); label.className='muted'; label.textContent='Choose mirror:';
    mirrorSelect = document.createElement('select'); mirrorSelect.style.width='100%'; mirrorSelect.style.padding='8px'; mirrorSelect.style.borderRadius='8px'; mirrorSelect.style.marginBottom='8px';
    const mirrors = (item.mirrors||[]);
    if(mirrors.length===0){ const opt = document.createElement('option'); opt.value=''; opt.textContent='(no mirrors configured)'; mirrorSelect.appendChild(opt); }
    mirrors.forEach((m,i)=>{ const opt = document.createElement('option'); opt.value=m; opt.textContent = `Mirror ${i+1}`; mirrorSelect.appendChild(opt); });
    info.appendChild(label); info.appendChild(mirrorSelect);
  } else {
    // game info: no mirrors
    const label = document.createElement('div'); label.className='muted'; label.textContent='This game will launch the embedded HTML.'; info.appendChild(label);
  }

  // actions: Edit cover/settings, Bookmark, Launch, Close
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='12px';
  const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Edit settings'; editBtn.addEventListener('click', ()=>{
    // open editor for this item
    document.body.removeChild(prompt);
    openEditor(type, item.id);
  });
  const bookmarkBtn = document.createElement('button'); bookmarkBtn.className='btn'; bookmarkBtn.textContent = item.bookmarked ? 'Remove bookmark' : 'Save (★)';
  bookmarkBtn.addEventListener('click', ()=>{ item.bookmarked=!item.bookmarked; saveStorage(); renderAll(); bookmarkBtn.textContent = item.bookmarked ? 'Remove bookmark' : 'Save (★)'; });
  const launchBtn = document.createElement('button'); launchBtn.className='btn primary'; launchBtn.textContent = 'Launch';
  launchBtn.addEventListener('click', ()=>{
    // choose url (mirror) for movies or game's html blob for games
    if(type==='movies'){
      const url = mirrorSelect ? mirrorSelect.value : (item.mirrors && item.mirrors[0]);
      if(!url){ alert('No mirror selected. Please add a mirror in item settings first.'); return; }
      openOverlayWithUrl(url);
    } else {
      // game's html in data: URL; open in iframe
      openOverlayWithUrl(item.html || '');
    }
    if(document.body.contains(prompt)) document.body.removeChild(prompt);
  });
  const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.addEventListener('click', ()=>{ if(document.body.contains(prompt)) document.body.removeChild(prompt); });

  actions.appendChild(editBtn); actions.appendChild(bookmarkBtn); actions.appendChild(launchBtn); actions.appendChild(closeBtn);

  container.appendChild(cov); container.appendChild(info);
  prompt.appendChild(title); prompt.appendChild(container); prompt.appendChild(actions);
  document.body.appendChild(prompt);
}

/* -------------------------
   Overlay player functions
   ------------------------- */
function openOverlayWithUrl(url){
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  playerFrame.src = url || '';
  overlayOpenInTab.onclick = ()=>{ if(playerFrame.src) window.open(playerFrame.src, '_blank'); };
}
overlayClose.addEventListener('click', closeOverlay);
function closeOverlay(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); setTimeout(()=>{ playerFrame.src=''; },250); }
overlayFullscreen.addEventListener('click', ()=>{ const el = playerFrame; if(el.requestFullscreen) el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); else if(el.msRequestFullscreen) el.msRequestFullscreen(); });

/* -------------------------
   Helpers
   ------------------------- */
function getCoverUrl(item, fallbackWidth=160, fallbackHeight=240){
  if(item.cover){
    return item.coverIsData ? item.cover : item.cover; // ensure file data URL works
  }
  // fallback SVG placeholder
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="${fallbackWidth}" height="${fallbackHeight}">
      <rect width="100%" height="100%" fill="#0b0b0b"/>
      <text x="50%" y="50%" fill="#666" font-family="Arial" font-size="14" text-anchor="middle" dominant-baseline="middle">No Cover</text>
    </svg>
  `);
}

/* -------------------------
   Init & wire everything
   ------------------------- */
function init(){
  // apply settings
  store = loadStorage();
  applyTheme();
  // set UI inputs
  if(store.background && !store.background.isFile) bgUrlIn.value = store.background.url || '';
  textColorIn.value = store.textColor || '#ffffff';
  autoUpdateIn.checked = !!store.autoUpdate;
  // render lists
  renderAll();

  // wire header buttons
  document.querySelectorAll('.task-icon').forEach(el=>{
    el.addEventListener('mouseenter', ()=> el.querySelector('.task-label').style.display='block');
    el.addEventListener('mouseleave', ()=> el.querySelector('.task-label').style.display='none');
  });
const UPDATE_SOURCE =
"https://drive.google.com/uc?export=download&id=YOUR_FILE_ID"; // direct
link
const CURRENT_VERSION = "1.0.0";
// Loads stored HTML version from localStorage (if available)
function loadStoredApp() {
const saved = localStorage.getItem(STORAGE_KEY);
if (saved) {
document.open();
document.write(saved);
document.close();
} else {
fetchAndStoreApp();
}
}
// Fetch latest HTML from Drive and save it
async function fetchAndStoreApp() {
try {
const res = await fetch(UPDATE_SOURCE);
if (!res.ok) throw new Error("Drive fetch failed");
const newHTML = await res.text();
localStorage.setItem(STORAGE_KEY, newHTML);
alert("App updated to the latest version. Reloading...");
location.reload();
} catch (err) {
console.error("Update failed:", err);
alert("Could not update from Drive — using built-in version.");
}
}
async function updateData(manual = false) {
  const updateURL = "https://example.com/update.json"; // your actual update URL
  const STORAGE_KEY = "hallows-eve:v2";

  try {
    const response = await fetch(updateURL, { cache: "no-store" });

    // Check if response is OK and JSON-parsable
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const newData = await response.json();
    if (!newData || typeof newData !== "object") throw new Error("Invalid JSON format");

    // Load current localStorage data
    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    const merged = mergeDataSafely(stored, newData);

    // Save only if valid merge occurred
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));

    if (manual) alert("Update successful!");
    console.log("Update applied successfully.");

  } catch (err) {
    console.warn("Update failed — keeping existing data:", err.message);
    if (manual) alert("Update failed — your current settings are safe.");
  }
}

// Helper merge: keeps existing data, adds new fields, never deletes
function mergeDataSafely(oldData, newData) {
  const merged = structuredClone(oldData);

  for (const key in newData) {
    if (Array.isArray(newData[key])) {
      const existing = new Set((oldData[key] || []).map(x => x.id));
      merged[key] = [
        ...(oldData[key] || []),
        ...newData[key].filter(x => !existing.has(x.id))
      ];
    } else if (typeof newData[key] === "object" && newData[key] !== null) {
      merged[key] = mergeDataSafely(oldData[key] || {}, newData[key]);
    } else {
      merged[key] = merged[key] ?? newData[key];
    }
  }

  return merged;
}

// Check if a new version exists (compare stored HTML)
async function checkForUpdate() {
try {
const res = await fetch(UPDATE_SOURCE + "?t=" + Date.now());
if (!res.ok) return;
const remoteHTML = await res.text();
const localHTML = localStorage.getItem(STORAGE_KEY);
if (remoteHTML !== localHTML) {
localStorage.setItem(STORAGE_KEY, remoteHTML);
showUpdateModal("A new version was found and installed!");
}
} catch (err) {
console.warn("No update found or blocked by filter:", err);
}
}
// Simple update notification modal
function showUpdateModal(msg) {
const modal = document.createElement("div");
modal.style = `
position: fixed; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.85); color: white; display: flex;
align-items: center; justify-content: center; flex-direction: column;
font-family: 'Poppins', sans-serif; z-index: 9999;
`;
modal.innerHTML = `
<h2>Update Installed</h2>
<p>${msg}</p>
<button style="margin-top: 10px; padding: 10px 20px; background:black;
color:white; border:none; cursor:pointer; border-radius:8px;">
Reload
</button>
`;
modal.querySelector("button").onclick = () => location.reload();
document.body.appendChild(modal);
}
// Run the updater safely
(async () => {
await checkForUpdate();
})();
  // quick page top nav
  document.getElementById('goHomeTop').addEventListener('click', ()=> showPage('home'));
  document.getElementById('goMoviesTop').addEventListener('click', ()=> showPage('movies'));
  document.getElementById('goGamesTop').addEventListener('click', ()=> showPage('games'));

  // settings toggles also via toggle button
  [btnSettingsToggle, openSettingsBtn].forEach(b=>b.addEventListener('click', ()=> toggleSettings()));

  // Save on window unload
  window.addEventListener('beforeunload', ()=> saveStorage());
}
init();

/* expose renderAll for debugging */
window.hallowsRender = renderAll;

</script>
</body>
</html>
